{% extends "base.html" %}
{% block title %}Reset PIN ‚Äì TVS NIRIX{% endblock %}

{% block content %}

<div class="row justify-content-center" style="margin-top:60px;">
  <div class="col-12 col-sm-10 col-md-6 col-lg-4">

    <div class="card shadow-sm p-4" style="border-radius:14px;">

      <!-- =====================================================
           HEADER
      ====================================================== -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold">Reset PIN</h5>
        <a href="{{ url_for('root') }}"
           class="btn btn-sm btn-outline-secondary">
          Login
        </a>
      </div>

      <!-- =====================================================
           ALERTS
      ====================================================== -->
      {% if error %}
        <div class="alert alert-danger py-2 small">
          {{ error }}
        </div>
      {% endif %}

      {% if message %}
        <div class="alert alert-info py-2 small">
          {{ message }}
        </div>
      {% endif %}

      <!-- =====================================================
           STEP 1 ‚Äî ENTER EMAIL
      ====================================================== -->
      {% if step == "email" %}

        <div class="small text-muted mb-3">
          Enter your registered email address.
          A 6-digit reset code will be generated after verification.
        </div>

        <form method="post" action="{{ url_for('forgot_pin') }}">

          <label class="form-label small fw-semibold">
            Email ID
          </label>

          <input type="email"
                 name="email"
                 class="form-control mb-3"
                 autocomplete="email"
                 placeholder="your.name@company.com"
                 required>

          <button class="btn btn-tvs w-100">
            SEND RESET CODE
          </button>

        </form>

      {% endif %}

      <!-- =====================================================
           STEP 2 ‚Äî VERIFY RESET CODE
      ====================================================== -->
      {% if step == "verify" %}

        <div class="small mb-2">
          Reset request initiated for:
          <strong>{{ email }}</strong>
        </div>

        <form method="post" action="{{ url_for('reset_pin_verify') }}">

          <!-- Persist email safely -->
          <input type="hidden" name="email" value="{{ email }}">

          <label class="form-label small fw-semibold">
            Reset Code
          </label>

          <input id="codeInput"
                 type="text"
                 name="code"
                 maxlength="6"
                 pattern="[0-9]{6}"
                 inputmode="numeric"
                 class="form-control text-center mb-3"
                 style="letter-spacing:6px; font-size:20px;"
                 placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                 required>

          <button class="btn btn-tvs w-100">
            VERIFY CODE
          </button>

        </form>

        <div class="mt-3 text-center small">
          Didn‚Äôt receive a code?
          <a href="{{ url_for('forgot_pin') }}">Resend</a>
        </div>

      {% endif %}

      <!-- =====================================================
           STEP 3 ‚Äî SET NEW PIN
      ====================================================== -->
      {% if step == "new_pin" %}

        <div class="small text-muted mb-3">
          Set a new 4-digit PIN for:
          <strong>{{ email }}</strong>
        </div>

        <form method="post" action="{{ url_for('reset_pin_new') }}">

          <!-- Persist email safely -->
          <input type="hidden" name="email" value="{{ email }}">

          <!-- NEW PIN -->
          <label class="form-label small fw-semibold">
            New PIN
          </label>

          <div class="position-relative mb-2">
            <input type="password"
                   name="pin"
                   id="pinField"
                   maxlength="4"
                   pattern="[0-9]{4}"
                   inputmode="numeric"
                   class="form-control"
                   placeholder="Enter 4-digit PIN"
                   required>

            <span id="togglePin"
                  class="position-absolute"
                  style="right:12px; top:10px; cursor:pointer; opacity:0.6;">
              üëÅ
            </span>
          </div>

          <!-- CONFIRM PIN -->
          <label class="form-label small fw-semibold">
            Confirm PIN
          </label>

          <div class="position-relative mb-3">
            <input type="password"
                   name="pin2"
                   id="pinConfirmField"
                   maxlength="4"
                   pattern="[0-9]{4}"
                   inputmode="numeric"
                   class="form-control"
                   placeholder="Re-enter PIN"
                   required>

            <span id="togglePinConfirm"
                  class="position-absolute"
                  style="right:12px; top:10px; cursor:pointer; opacity:0.6;">
              üëÅ
            </span>
          </div>

          <button class="btn btn-tvs w-100">
            RESET PIN
          </button>

        </form>

      {% endif %}

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
/* =====================================================
   AUTOFOCUS RESET CODE
===================================================== */
(function () {
  const codeInput = document.getElementById("codeInput");
  if (codeInput) codeInput.focus();

  /* PIN VISIBILITY TOGGLES */
  const pin = document.getElementById("pinField");
  const pin2 = document.getElementById("pinConfirmField");
  const t1 = document.getElementById("togglePin");
  const t2 = document.getElementById("togglePinConfirm");

  if (t1 && pin) {
    t1.onclick = () =>
      pin.type = pin.type === "password" ? "text" : "password";
  }

  if (t2 && pin2) {
    t2.onclick = () =>
      pin2.type = pin2.type === "password" ? "text" : "password";
  }
})();
</script>
{% endblock %}
