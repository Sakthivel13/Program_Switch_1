{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nirix.tvsmotor.com/schema/section.schema.json",
  "title": "Vehicle Section Tests Definition",
  "description": "Defines sections (Diagnostics/Vehicle Health) and their contents for a vehicle",
  "version": "2.1.0",
  "type": "object",
  "required": ["vehicle", "sections"],

  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "2.1.0",
      "description": "Schema version for compatibility checking"
    },

    "vehicle": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "Vehicle model name (must match app.vehicles.name)"
    },

    "sections": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/section" }
    }
  },

  "additionalProperties": false,

  "$defs": {
    "section": {
      "type": "object",
      "required": ["name", "slug", "section_type"],

      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display name (e.g., 'Diagnostics', 'Vehicle Health Report')"
        },

        "slug": {
          "type": "string",
          "pattern": "^[a-z0-9_-]+$",
          "minLength": 1,
          "maxLength": 100,
          "description": "URL-safe identifier"
        },

        "section_type": {
          "type": "string",
          "enum": ["diagnostics", "vehicle_health"],
          "description": "Maps to app.vehicle_sections.section_type"
        },

        "description": {
          "type": ["string", "null"],
          "maxLength": 500,
          "description": "Section description"
        },

        "icon": {
          "type": ["string", "null"],
          "maxLength": 100,
          "description": "Icon class or path (e.g., fa-stethoscope)"
        },

        "sort_order": {
          "type": "integer",
          "minimum": 0,
          "maximum": 9999,
          "default": 0,
          "description": "Display order for sections"
        },

        "auto_run_programs": {
          "type": "array",
          "description": "Programs to run automatically when entering this section",
          "items": { "$ref": "#/$defs/auto_run_program" },
          "default": []
        },

        "is_active": {
          "type": "boolean",
          "default": true,
          "description": "Whether this section is active"
        },

        "ecus": {
          "type": "array",
          "description": "ECU code list (typically for diagnostics section)",
          "items": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 1,
            "maxLength": 50,
            "description": "ECU code reference (links to ecu_tests.json)"
          },
          "default": []
        },

        "health_tabs": {
          "type": "array",
          "description": "Health report tabs (typically for vehicle_health section)",
          "items": { "$ref": "#/$defs/health_tab" },
          "default": []
        }
      },

      "additionalProperties": false
    },

    "auto_run_program": {
      "type": "object",
      "required": ["program_id", "module_name", "function_name"],

      "properties": {
        "program_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_-]+$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Logical program ID; also used as test_id for persistence/logging"
        },

        "program_name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Friendly name for the program"
        },

        "program_type": {
          "type": "string",
          "enum": ["single", "stream"],
          "default": "single",
          "description": "High-level type used by runner auto-run session (single-shot vs streaming)"
        },

        "module_name": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Python module name (without .py) inside Auto_Run or Diagnostics/Auto_Run"
        },

        "function_name": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Python function name inside the module"
        },

        "execution_mode": {
          "type": "string",
          "enum": ["single", "stream", "flash", "flashing", "live"],
          "default": "single",
          "description": "Execution mode passed into ExecutionContext (mapped by loader._map_execution_mode)"
        },

        "display_type": {
          "type": "string",
          "enum": ["text", "value", "status", "json", "gauge", "chart"],
          "default": "text",
          "description": "UI hint for how to display result"
        },

        "display_label": {
          "type": "string",
          "maxLength": 100,
          "description": "Label shown in UI (e.g., 'Battery Voltage')"
        },

        "display_unit": {
          "type": ["string", "null"],
          "maxLength": 20,
          "description": "Optional unit label (e.g., 'V', '°C', 'rpm')"
        },

        "display_pages": {
          "type": "array",
          "description": "Where in the UI this auto-run result should be shown",
          "items": {
            "type": "string",
            "enum": ["section", "ecu", "parameter"]
          },
          "minItems": 0,
          "maxItems": 3,
          "uniqueItems": true,
          "default": ["section", "ecu", "parameter"]
        },

        "ecu_targets": {
          "type": "array",
          "description": "List of ECU codes that this auto-run program targets (used for ECU-specific Auto_Run folders)",
          "items": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 1,
            "maxLength": 50
          },
          "default": []
        },

        "output_limits": {
          "type": "array",
          "description": "Optional LSL/USL limits for the auto-run program output",
          "items": { "$ref": "#/$defs/output_limit" },
          "default": []
        },

        "fallback_action": {
          "type": "string",
          "enum": ["none", "manual_input", "warn_and_continue", "block"],
          "default": "none",
          "description": "What to do if the auto-run fails"
        },

        "fallback_input": {
          "oneOf": [
            { "$ref": "#/$defs/fallback_input_config" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Optional config for manual input when fallback_action is 'manual_input'"
        },

        "log_as_vin": {
          "type": "boolean",
          "default": false,
          "description": "If true, result_value is treated as VIN in auto-run session"
        },

        "is_required": {
          "type": "boolean",
          "default": true,
          "description": "If true, section entry is blocked on failure"
        },

        "timeout_sec": {
          "type": "number",
          "minimum": 0,
          "maximum": 3600,
          "default": 15,
          "description": "Timeout in seconds for this auto-run program (0 = no timeout, run indefinitely)"
        },

        "sort_order": {
          "type": "integer",
          "minimum": 0,
          "maximum": 9999,
          "default": 0,
          "description": "Display and execution ordering for auto-run programs"
        },

        "source": {
          "type": "string",
          "enum": ["section", "ecu"],
          "default": "section",
          "description": "Source of the auto-run program (added by loader)"
        }
      },

      "additionalProperties": false
    },

    "fallback_input_config": {
      "type": "object",
      "properties": {
        "label": {
          "type": "string",
          "maxLength": 100,
          "description": "Label for the input field"
        },
        "input_type": {
          "type": "string",
          "enum": ["string", "int", "float", "hex"],
          "default": "string",
          "description": "Type of input"
        },
        "length": {
          "type": "integer",
          "minimum": 1,
          "maximum": 255,
          "description": "Required length for string/hex inputs"
        },
        "format_hint": {
          "type": "string",
          "maxLength": 200,
          "description": "Hint text for the input format"
        },
        "is_required": {
          "type": "boolean",
          "default": true,
          "description": "Whether input is required"
        },
        "default_value": {
          "type": ["string", "null"],
          "description": "Default value for the input"
        },
        "validation_pattern": {
          "type": ["string", "null"],
          "description": "Regex pattern for input validation"
        }
      },
      "additionalProperties": false
    },

    "output_limit": {
      "type": "object",
      "required": ["signal"],

      "properties": {
        "signal": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_]+$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Signal name in the program output (e.g., 'battery_voltage')"
        },
        "lsl": {
          "type": ["number", "null"],
          "description": "Lower specification limit (inclusive)"
        },
        "usl": {
          "type": ["number", "null"],
          "description": "Upper specification limit (inclusive)"
        },
        "unit": {
          "type": ["string", "null"],
          "maxLength": 20,
          "description": "Optional unit (e.g., 'V', '°C', 'rpm')"
        }
      },

      "additionalProperties": false
    },

    "health_tab": {
      "type": "object",
      "required": ["folder_code", "folder_name"],

      "properties": {
        "folder_code": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_-]+$",
          "minLength": 1,
          "maxLength": 50,
          "description": "Maps to app.vehicle_health_folders.folder_code"
        },

        "folder_name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Tab display name - maps to folder_name"
        },

        "description": {
          "type": ["string", "null"],
          "maxLength": 500,
          "description": "Tab description"
        },

        "execution_class": {
          "type": "string",
          "enum": ["STREAM", "SINGLE", "FLASH", "DUAL"],
          "default": "SINGLE",
          "description": "Maps to app.vehicle_health_folders.execution_class"
        },

        "icon": {
          "type": ["string", "null"],
          "maxLength": 100,
          "description": "Icon class or path"
        },

        "sort_order": {
          "type": "integer",
          "minimum": 0,
          "maximum": 9999,
          "default": 0
        },

        "is_active": {
          "type": "boolean",
          "default": true
        }
      },

      "additionalProperties": false
    }
  }
}
