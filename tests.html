{% extends "base.html" %}
{% block title %}Tests – {{ model_name if model_name else "Select Vehicle" }}{% endblock %}

{% block head %}
<style>
  /* ===================== GLOBAL ===================== */
  :root {
    --card-radius: 16px;
    --transition-speed: 0.2s;
    --tile-hover-transform: translateY(-2px);
  }

  .card { border-radius: var(--card-radius); }
  .card-shadow { 
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease;
  }
  .card-shadow:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  }

  .rounded-strip{
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--card-radius);
    overflow: hidden;
  }

  .rounded-box{
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--card-radius);
  }

  .log-area{
    height: 420px;
    background: #020617;
    color: #e5e7eb;
    font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size: .78rem;
    overflow: auto;
    padding: 12px;
    border-radius: 12px;
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.5;
  }

  body.dark .log-area {
    background: #0f172a;
    color: #e2e8f0;
  }

  .log-area-mini{
    height: 200px;
    background: #020617;
    color: #e5e7eb;
    font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size: .75rem;
    overflow: auto;
    padding: 10px;
    border-radius: 10px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .subtle-muted{ color: var(--muted-text); }

  /* ===================== VEHICLE HERO STRIP ===================== */
  .vehicle-hero{
    display: flex;
    gap: 16px;
    align-items: stretch;
    min-height: 100px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--card-radius);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }
  
  .vehicle-hero .img-wrap{
    width: 160px;
    min-height: 100px;
    background: linear-gradient(135deg, var(--border-color), var(--bg-main));
    flex: 0 0 auto;
  }
  
  .vehicle-hero img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  .vehicle-hero .meta{
    padding: 16px;
    flex: 1 1 auto;
    display: flex;
    justify-content: space-between;
    gap: 16px;
  }
  
  .vehicle-hero .meta .left .name{
    font-weight: 800;
    color: var(--text-main);
    line-height: 1.2;
    font-size: 1.25rem;
    margin-bottom: 4px;
  }
  
  .vehicle-hero .meta .left .desc{
    color: var(--muted-text);
    font-size: .9rem;
  }
  
  .vehicle-hero .meta .right{
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: center;
    gap: 8px;
  }

  .vin-pill{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background: var(--bg-main);
    color: var(--text-main);
    font-size: .85rem;
    font-weight: 700;
    white-space: nowrap;
  }
  
  .vin-pill .mono{ 
    font-family: 'Courier New', monospace; 
    font-weight: 900;
    letter-spacing: 1px;
  }

  /* ===================== ECU STATUS DOT ===================== */
  .ecu-status-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all var(--transition-speed) ease;
  }
  
  .ecu-status-dot.active {
    background: #10b981;
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    animation: pulse-green 2s infinite;
  }
  
  .ecu-status-dot.inactive {
    background: #ef4444;
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
  }
  
  .ecu-status-dot.unknown {
    background: #9ca3af;
    box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.2);
  }

  @keyframes pulse-green {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
    70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
  }

  /* ===================== GRID LIST (CARDS) ===================== */
  .grid-wrap{ padding: 20px; }
  
  .grid-title{
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .grid-title h5{ 
    font-weight: 800; 
    margin: 0;
    font-size: 1.1rem;
  }

  .tile-grid{
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
  }
  
  .tile{
    grid-column: span 12;
    border: 2px solid var(--border-color);
    border-radius: var(--card-radius);
    padding: 16px;
    background: var(--card-bg);
    transition: all var(--transition-speed) ease;
    text-decoration: none;
    color: inherit;
    display: flex;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  
  .tile:hover{
    border-color: var(--tvs-blue-light);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
    transform: var(--tile-hover-transform);
  }
  
  .tile:active {
    transform: translateY(0);
  }
  
  .tile .left{ min-width: 0; flex: 1; }
  
  .tile .title{
    font-weight: 800;
    margin: 0;
    color: var(--text-main);
    line-height: 1.2;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.1rem;
  }
  
  .tile .subtitle{
    margin-top: 4px;
    font-size: .9rem;
    color: var(--muted-text);
  }
  
  .tile .badges{
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  
  .badge-soft{
    font-size: .75rem;
    padding: .3rem .7rem;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background: var(--bg-main);
    color: var(--text-main);
    white-space: nowrap;
    font-weight: 500;
  }
  
  .badge-soft.stream{ 
    background: #fff7ed; 
    border-color: #fed7aa; 
    color: #9a3412; 
  }
  
  body.dark .badge-soft.stream {
    background: #7c2d12;
    border-color: #9a3412;
    color: #fed7aa;
  }
  
  .badge-soft.single{ 
    background: var(--bg-main); 
    border-color: var(--border-color); 
    color: var(--text-main); 
  }
  
  .badge-soft.flash{ 
    background: #f3e8ff; 
    border-color: #e9d5ff; 
    color: #6b21a8; 
  }
  
  body.dark .badge-soft.flash {
    background: #4a1d96;
    border-color: #6b21a8;
    color: #e9d5ff;
  }
  
  .badge-soft.dual{ 
    background: #ecfeff; 
    border-color: #a5f3fc; 
    color: #155e75; 
  }

  .tile-icon{
    width: 24px;
    height: 24px;
    object-fit: contain;
    display: block;
  }

  @media (min-width: 576px){ .tile{ grid-column: span 6; } }
  @media (min-width: 992px){ .tile{ grid-column: span 4; } }

  /* ===================== TEST SEQUENCE PAGE ===================== */
  .seq-layout{
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  @media (min-width: 1400px){
    .seq-layout{
      grid-template-columns: 1fr 400px;
      align-items: start;
    }
  }

  .seq-header{
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .breadcrumbs{
    font-size: .9rem;
    color: var(--muted-text);
  }
  
  .breadcrumbs strong{ color: var(--text-main); }

  /* ===================== SEQUENCE ROWS ===================== */
  .seq-list{ padding: 16px 20px 20px; }
  
  .seq-row{
    border: 2px solid var(--border-color);
    border-radius: var(--card-radius);
    padding: 16px;
    background: var(--card-bg);
    display: grid;
    grid-template-columns: 1.6fr .8fr 1.2fr .55fr;
    gap: 16px;
    align-items: center;
    margin-bottom: 16px;
    transition: all var(--transition-speed) ease;
  }
  
  .seq-row:hover {
    border-color: var(--tvs-blue-light);
  }
  
  .seq-row .info h6{
    margin: 0;
    font-weight: 800;
    color: var(--text-main);
    font-size: 1rem;
  }
  
  .seq-row .info .desc{
    margin-top: 4px;
    color: var(--muted-text);
    font-size: .86rem;
    line-height: 1.4;
  }
  
  .seq-row .output{
    border: 1px solid var(--border-color);
    background: var(--bg-main);
    border-radius: 12px;
    min-height: 48px;
    padding: 8px 12px;
    font-family: 'Courier New', monospace;
    font-size: .85rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: all var(--transition-speed) ease;
  }
  
  .seq-row .status{
    text-align: center;
    font-weight: 700;
    font-size: .8rem;
    border-radius: 999px;
    padding: 8px 12px;
    border: 1px solid transparent;
  }
  
  .st-idle{ background: var(--bg-main); color: var(--muted-text); border-color: var(--border-color); }
  .st-running{ background: #fff7ed; color: #9a3412; border-color: #fed7aa; }
  .st-streaming{ background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
  .st-success{ background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
  .st-failed{ background: #fef2f2; color: #991b1b; border-color: #fecaca; }
  .st-paused{ background: #f1f5f9; color: #475569; border-color: #cbd5e1; }

  body.dark .st-running{ background: #7c2d12; color: #fed7aa; border-color: #9a3412; }
  body.dark .st-streaming{ background: #075985; color: #e0f2fe; border-color: #0284c7; }
  body.dark .st-success{ background: #14532d; color: #a7f3d0; border-color: #166534; }
  body.dark .st-failed{ background: #7f1d1d; color: #fecaca; border-color: #991b1b; }
  body.dark .st-paused{ background: #334155; color: #cbd5e1; border-color: #475569; }

  .seq-row.running{ border-color: #f59e0b; background: rgba(245, 158, 11, 0.05); }
  .seq-row.streaming{ border-color: #0284c7; background: rgba(2, 132, 199, 0.05); }
  .seq-row.success{ border-color: #10b981; background: rgba(16, 185, 129, 0.05); }
  .seq-row.failed { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }

  /* ===================== LSL/USL LIMIT COLOR CODING ===================== */
  .value-within{
    background: #ecfdf5 !important;
    color: #065f46 !important;
    font-weight: 800;
    border-color: #a7f3d0 !important;
  }
  
  .value-violation{
    background: #fee2e2 !important;
    color: #991b1b !important;
    font-weight: 800;
    border-color: #fecaca !important;
  }

  body.dark .value-within{
    background: #14532d !important;
    color: #a7f3d0 !important;
    border-color: #166534 !important;
  }
  
  body.dark .value-violation{
    background: #7f1d1d !important;
    color: #fecaca !important;
    border-color: #991b1b !important;
  }

  /* ===================== STREAM VALUES PANEL ===================== */
  .stream-panel{
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: var(--card-radius);
    padding: 16px;
    margin-bottom: 20px;
    transition: all var(--transition-speed) ease;
  }
  
  .stream-panel:hover {
    border-color: var(--tvs-blue-light);
  }
  
  .stream-panel .header{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .stream-panel .header h6{
    margin: 0;
    font-weight: 800;
    color: var(--text-main);
    font-size: 1rem;
  }
  
  .stream-panel .header .badge{
    background: var(--tvs-blue);
    color: white;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: .7rem;
    font-weight: 600;
  }
  
  .stream-value-row{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
  }
  
  .stream-value-row:last-child{
    border-bottom: none;
  }
  
  .stream-value-row .label{
    font-weight: 600;
    color: var(--text-main);
  }
  
  .stream-value-row .value{
    font-family: 'Courier New', monospace;
    font-weight: 700;
    font-size: 1.2rem;
  }
  
  .stream-value-row .value.within{
    color: #10b981;
  }
  
  .stream-value-row .value.violation{
    color: #ef4444;
  }
  
  .stream-value-row .unit{
    font-size: .8rem;
    color: var(--muted-text);
    margin-left: 4px;
  }
  
  .stream-timestamp{
    font-size: .7rem;
    color: var(--muted-text);
    text-align: right;
    margin-top: 12px;
    border-top: 1px dashed var(--border-color);
    padding-top: 8px;
  }

  @media (max-width: 768px){
    .seq-row{
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .vehicle-hero {
      flex-direction: column;
    }
    
    .vehicle-hero .img-wrap {
      width: 100%;
      height: 120px;
    }
  }

  /* ===================== INLINE INPUTS (IUPR SECONDARY) ===================== */
  .inline-inputs{
    grid-column: 1 / -1;
    margin-top: 12px;
    border-top: 1px dashed var(--border-color);
    padding-top: 12px;
  }
  
  .inline-inputs .form-text{ color: var(--muted-text); }

  /* ===================== TOGGLE LIST ===================== */
  .toggle-row{
    border: 2px solid var(--border-color);
    border-radius: var(--card-radius);
    padding: 16px;
    background: var(--card-bg);
    display: flex;
    justify-content: space-between;
    gap: 16px;
    align-items: center;
    margin-bottom: 16px;
    transition: all var(--transition-speed) ease;
  }
  
  .toggle-row:hover {
    border-color: var(--tvs-blue-light);
  }

  /* ===================== FLASH / STATUS COLORS ===================== */
  .flash-start  { background: #F3E8FF; color: #6B21A8; }
  .flash-success{ background: #ECFDF5; color: #065F46; }
  .flash-fail   { background: #FEF2F2; color: #991B1B; }
  .flash-request{ background: #FEF3E2; color: #B45309; }

  body.dark .flash-start  { background: #4a1d96; color: #e9d5ff; }
  body.dark .flash-success{ background: #14532d; color: #a7f3d0; }
  body.dark .flash-fail   { background: #7f1d1d; color: #fecaca; }
  body.dark .flash-request{ background: #7c2d12; color: #fed7aa; }

  /* ===================== PROGRESS BAR ===================== */
  .progress-container { 
    background: var(--border-color); 
    border-radius: 999px; 
    height: 10px; 
    overflow: hidden; 
  }
  
  .progress-bar-custom { 
    height: 100%; 
    transition: width 0.25s ease; 
    border-radius: 999px; 
    position: relative; 
  }
  
  .progress-bar-custom.animated::after {
    content: '';
    display: block;
    height: 100%;
    width: 100%;
    background: linear-gradient(45deg, 
      transparent 40%, 
      rgba(255,255,255,0.35) 50%, 
      transparent 60%);
    animation: shimmer 1.8s infinite linear;
  }
  
  @keyframes shimmer { 
    0% { transform: translateX(-100%); } 
    100% { transform: translateX(100%); } 
  }

  /* ===================== INPUT VALIDATION (ENHANCED) ===================== */
  .input-validation-error {
    border-color: #ef4444 !important;
    background-color: #fef2f2 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
  }
  
  .input-validation-success {
    border-color: #10b981 !important;
    background-color: #ecfdf5 !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
  }

  body.dark .input-validation-error {
    background-color: #7f1d1d !important;
    border-color: #ef4444 !important;
  }
  
  body.dark .input-validation-success {
    background-color: #14532d !important;
    border-color: #10b981 !important;
  }

  .field-error-message {
    color: #ef4444;
    font-size: 0.75rem;
    margin-top: 0.25rem;
    display: none;
  }
  
  .field-error-message.active { display: block; }

  /* ===================== AUTO-RUN MODAL ===================== */
  .auto-run-program-item {
    background: var(--bg-main);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
    transition: all var(--transition-speed) ease;
  }
  
  .auto-run-program-item:hover {
    background: var(--card-bg);
    border-color: var(--tvs-blue-light);
  }
  
  .auto-run-program-item.success {
    border-left: 4px solid #10b981;
  }
  
  .auto-run-program-item.failed {
    border-left: 4px solid #ef4444;
  }
  
  .auto-run-program-item.running {
    border-left: 4px solid #f59e0b;
    animation: pulse-border 1.5s infinite;
  }
  
  @keyframes pulse-border {
    0% { border-left-color: #f59e0b; }
    50% { border-left-color: #fbbf24; }
    100% { border-left-color: #f59e0b; }
  }

  /* ===================== VEHICLE SELECTION TILES (FIX-37) ===================== */
  .vehicle-tile {
    padding: 16px !important;
  }
  
  .vehicle-tile .vehicle-image {
    width: 80px;
    height: 60px;
    border-radius: 10px;
    overflow: hidden;
    flex-shrink: 0;
    background: linear-gradient(135deg, var(--border-color), var(--bg-main));
  }
  
  .vehicle-tile .vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .vehicle-tile .vehicle-details {
    flex: 1;
    min-width: 0;
  }
  
  .vehicle-tile .vehicle-name {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .vehicle-tile .vehicle-category {
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    background: var(--bg-main);
    border-radius: 999px;
    color: var(--muted-text);
  }
  
  .vehicle-tile .vehicle-description {
    font-size: 0.85rem;
    color: var(--muted-text);
    margin-bottom: 4px;
  }
  
  .vehicle-tile .vin-pattern {
    font-size: 0.75rem;
    font-family: 'Courier New', monospace;
    background: var(--bg-main);
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
  }

  /* ===================== EMPTY STATES ===================== */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--card-bg);
    border-radius: var(--card-radius);
    border: 1px solid var(--border-color);
  }
  
  .empty-state i {
    font-size: 4rem;
    color: var(--muted-text);
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .empty-state h3 {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .empty-state p {
    color: var(--muted-text);
    margin-bottom: 1.5rem;
  }

  /* ===================== LOADING SKELETON ===================== */
  .skeleton {
    background: linear-gradient(90deg, 
      var(--border-color) 25%, 
      var(--card-bg) 50%, 
      var(--border-color) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
    height: 60px;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* ===================== PRINT STYLES ===================== */
  @media print {
    .no-print,
    .btn,
    .stream-panel,
    .log-area {
      display: none !important;
    }
    
    .seq-row {
      break-inside: avoid;
      border: 1px solid #000;
    }
  }
</style>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}

{% block content %}

{% if not model_name %}
<!-- ====================================================================== -->
<!-- PHASE 0 : VEHICLE SELECTION (ENHANCED WITH IMAGES, DESC, VIN PATTERN) -->
<!-- ====================================================================== -->
<div class="row justify-content-center">
  <div class="col-11 col-xl-10">
    <div class="rounded-box card-shadow grid-wrap">
      <div class="grid-title">
        <div>
          <h5><i class="fas fa-car me-2"></i>Select Vehicle Model</h5>
          <div class="subtle-muted">Choose a vehicle to load Diagnostics and Vehicle Health Report tests</div>
        </div>
        
        <!-- Search and filter -->
        <div class="d-flex gap-2">
          <div class="position-relative">
            <input type="text" 
                   id="vehicleSearch" 
                   class="form-control form-control-sm" 
                   placeholder="Search vehicles..." 
                   style="width: 250px; padding-left: 2rem;">
            <i class="fas fa-search position-absolute" 
               style="left: 0.75rem; top: 0.6rem; color: var(--muted-text); font-size: 0.85rem;"></i>
          </div>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearVehicleSearch()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      {% if vehicles %}
      <div class="tile-grid" id="vehicleGrid">
        {% for v in vehicles %}
        <a class="tile vehicle-tile" 
           href="{{ url_for('tests_root', model=v.name) }}"
           data-vehicle-name="{{ v.name|lower }}"
           data-vehicle-category="{{ v.category|lower if v.category else '' }}"
           data-vehicle-description="{{ v.description|lower if v.description else '' }}">
          
          <!-- Left section with image and details -->
          <div class="left" style="display: flex; gap: 16px; width: 100%;">
            <!-- Vehicle Image -->
            <div class="vehicle-image">
              {% if v.image_filename %}
                <img src="{{ url_for('vehicle_image', filename=v.image_filename) }}" 
                     alt="{{ v.name }}"
                     loading="lazy">
              {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
                  <i class="fas fa-car fa-2x" style="color: var(--muted-text); opacity:0.5;"></i>
                </div>
              {% endif %}
            </div>
            
            <!-- Vehicle Details -->
            <div class="vehicle-details">
              <div class="vehicle-name">
                {{ v.name }}
                {% if v.category %}
                <span class="vehicle-category">{{ v.category }}</span>
                {% endif %}
              </div>
              
              {% if v.description %}
              <div class="vehicle-description">{{ v.description }}</div>
              {% endif %}
              
              {% if v.vin_pattern %}
              <div class="mt-1">
                <span class="vin-pattern">
                  <i class="fas fa-barcode me-1" style="font-size: 0.7rem;"></i>
                  {{ v.vin_pattern }}
                </span>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Right section with action -->
          <div class="badges">
            <span class="badge-soft" style="display: flex; align-items: center; gap: 4px;">
              <span>Select Vehicle</span>
              <i class="fas fa-arrow-right"></i>
            </span>
          </div>
        </a>
        {% endfor %}
      </div>
      
      <!-- No vehicles found message (for search) -->
      <div id="noVehiclesFound" class="empty-state" style="display: none;">
        <i class="fas fa-search"></i>
        <h3>No Vehicles Found</h3>
        <p>No vehicles match your search criteria. Try a different search term.</p>
        <button class="btn btn-tvs" onclick="clearVehicleSearch()">
          <i class="fas fa-times me-2"></i>Clear Search
        </button>
      </div>
      
      {% else %}
      <div class="empty-state">
        <i class="fas fa-car"></i>
        <h3>No Vehicles Available</h3>
        <p>No vehicle models are available for your account.</p>
        <a href="{{ url_for('dashboard') }}" class="btn btn-tvs">
          <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add JavaScript for live filtering -->
<script>
(function() {
  const searchInput = document.getElementById('vehicleSearch');
  const vehicleGrid = document.getElementById('vehicleGrid');
  const noVehiclesMsg = document.getElementById('noVehiclesFound');
  
  if (!searchInput || !vehicleGrid) return;
  
  const vehicleTiles = document.querySelectorAll('.vehicle-tile');
  
  function filterVehicles() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;
    
    vehicleTiles.forEach(tile => {
      const name = tile.dataset.vehicleName || '';
      const category = tile.dataset.vehicleCategory || '';
      const description = tile.dataset.vehicleDescription || '';
      
      const matches = searchTerm === '' || 
                      name.includes(searchTerm) || 
                      category.includes(searchTerm) || 
                      description.includes(searchTerm);
      
      tile.style.display = matches ? 'flex' : 'none';
      if (matches) visibleCount++;
    });
    
    if (noVehiclesMsg) {
      noVehiclesMsg.style.display = visibleCount === 0 ? 'block' : 'none';
    }
    
    // Update result count
    const resultCount = document.getElementById('resultCount');
    if (resultCount) {
      resultCount.textContent = visibleCount;
    }
  }
  
  searchInput.addEventListener('input', filterVehicles);
  
  window.clearVehicleSearch = function() {
    searchInput.value = '';
    filterVehicles();
    searchInput.focus();
  };
})();
</script>

{% else %}

{% set _vin = current_vin|default('') %}
{% set _auto_run_session_id = auto_run_session_id|default('') %}

<!-- ====================================================================== -->
<!-- VEHICLE HERO STRIP (Visible on all pages) - FIX-31, FIX-70 -->
<!-- ====================================================================== -->
<div class="row justify-content-center mb-4">
  <div class="col-11 col-xl-10">
    <div class="vehicle-hero">
      <div class="img-wrap">
        {% if selected_vehicle and selected_vehicle.image_filename %}
          <img src="{{ url_for('vehicle_image', filename=selected_vehicle.image_filename) }}" 
               alt="{{ model_name }} image"
               loading="lazy">
        {% else %}
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
            <i class="fas fa-car fa-3x" style="color: var(--muted-text); opacity:0.5;"></i>
          </div>
        {% endif %}
      </div>
      
      <div class="meta">
        <div class="left">
          <div class="name">{{ model_name }}</div>
          <div class="desc">
            {% if selected_vehicle and selected_vehicle.description %}
              {{ selected_vehicle.description }}
            {% else %}
              {% if selected_vehicle and selected_vehicle.category %}
                Category: {{ selected_vehicle.category }}
              {% else %}
                <span class="text-muted">No description available</span>
              {% endif %}
            {% endif %}
            
            {% if selected_vehicle and selected_vehicle.vin_pattern %}
              <div class="small text-muted mt-2">
                <i class="fas fa-barcode me-1"></i>
                VIN Pattern: <span class="font-monospace fw-bold">{{ selected_vehicle.vin_pattern }}</span>
              </div>
            {% endif %}
          </div>
        </div>
        
        <div class="right">
          {% if selected_vehicle and selected_vehicle.category %}
            <span class="badge-soft">{{ selected_vehicle.category }}</span>
          {% endif %}
          
          <!-- VIN Display (FIX-31, FIX-70) -->
          {% if _vin %}
            <div class="vin-pill" id="vinDisplay">
              <i class="fas fa-qrcode"></i>
              <span>VIN:</span>
              <span class="mono" id="vinValue">{{ _vin }}</span>
              <span class="badge bg-{{ 'success' if vin_source == 'auto' else 'warning' }} ms-1" 
                    style="font-size: 0.6rem;"
                    title="VIN source: {{ vin_source }}">
                {{ vin_source|upper }}
              </span>
            </div>
          {% endif %}
          
          <!-- Change Vehicle Button -->
          <a class="btn btn-sm btn-outline-secondary" 
             href="{{ url_for('tests_root') }}"
             title="Change vehicle">
            <i class="fas fa-exchange-alt me-1"></i>
            <span class="d-none d-sm-inline">Change Vehicle</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ====================================================================== -->
<!-- PHASE 1 : SECTION SELECTION (FIX-60, FIX-62) -->
<!-- ====================================================================== -->
{% if not section %}
<div class="row justify-content-center">
  <div class="col-11 col-xl-10">
    <div class="rounded-box card-shadow grid-wrap">
      <div class="grid-title">
        <div>
          <h5><i class="fas fa-layer-group me-2"></i>Select Test Section</h5>
          <div class="subtle-muted">Diagnostics / Vehicle Health Report</div>
        </div>
        
        <!-- Auto-run session indicator -->
        {% if _auto_run_session_id %}
        <span class="badge bg-success">
          <i class="fas fa-play me-1"></i>Auto-run Active
        </span>
        {% endif %}
      </div>

      {% set sections_list = sections or [] %}
      {% if not sections_list %}
        <div class="empty-state">
          <i class="fas fa-layer-group"></i>
          <h3>No Sections Found</h3>
          <p>No test sections are configured for this vehicle.</p>
        </div>
      {% else %}
      <div class="tile-grid">
        {% for s in sections_list %}
        {% set stype = (s.section_type if s is mapping else '') %}
        {% set slug  = (s.slug if s is mapping else '') %}
        <a
          class="tile js-section-tile"
          href="{{ url_for('tests_root', model=model_name, section=slug, auto_run_session_id=_auto_run_session_id) }}"
          data-section-type="{{ stype }}"
          data-section-slug="{{ slug }}">
          
          <div class="left">
            <div class="d-flex align-items-center gap-3">
              {% if s is mapping and s.icon %}
                {% set icon = s.icon %}
                {% if icon.endswith('.svg') or icon.endswith('.png') or icon.endswith('.jpg') or icon.endswith('.jpeg') %}
                  <img src="{{ url_for('static', filename=icon) }}" alt="" class="tile-icon">
                {% else %}
                  {% if icon.startswith("fa-") or " fa-" in icon or icon.startswith("fa ") %}
                    <i class="{{ icon }}" style="font-size: 1.2rem; color: var(--tvs-blue);"></i>
                  {% else %}
                    <span>{{ icon }}</span>
                  {% endif %}
                {% endif %}
              {% endif %}
              
              <div>
                <div class="title">{{ s.name if s is mapping else slug }}</div>
                <div class="subtitle">{{ s.description if s is mapping else '' }}</div>
                
                <!-- Auto-run programs count (FIX-60) -->
                {% if s is mapping and s.auto_run_programs %}
                  <div class="small text-muted mt-2">
                    <i class="fas fa-play-circle me-1"></i>
                    {{ s.auto_run_programs|length }} auto-run program(s)
                    {% if stype == 'diagnostics' %}
                      <span class="badge bg-info text-dark ms-1" style="font-size: 0.6rem;">Section</span>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="badges">
            {% if stype == 'diagnostics' %}
              <span class="badge-soft">
                <i class="fas fa-microchip me-1"></i>Diagnostics
              </span>
            {% else %}
              <span class="badge-soft">
                <i class="fas fa-heartbeat me-1"></i>Vehicle Health
              </span>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ====================================================================== -->
<!-- PHASE 2 : ECU SELECTION (Diagnostics only) - FIX-61, FIX-65 -->
<!-- ====================================================================== -->
{% elif section == "diagnostics" and not ecu %}
<div class="row justify-content-center">
  <div class="col-11 col-xl-10">
    <div class="rounded-box card-shadow grid-wrap">
      <div class="grid-title">
        <div>
          <h5><i class="fas fa-microchip me-2"></i>Select ECU</h5>
          <div class="subtle-muted">{{ model_name }} · Diagnostics</div>
          
          <!-- VIN Display (FIX-70) -->
          {% if _vin %}
            <div class="mt-2 vin-pill">
              <i class="fas fa-qrcode"></i>
              <span>VIN:</span>
              <span class="mono">{{ _vin }}</span>
            </div>
          {% endif %}
        </div>
        
        <div class="d-flex gap-2">
          {% if _auto_run_session_id %}
          <span class="badge bg-success">
            <i class="fas fa-play me-1"></i>Auto-run Active
          </span>
          {% endif %}
          <a class="btn btn-sm btn-outline-secondary" 
             href="{{ url_for('tests_root', model=model_name, auto_run_session_id=_auto_run_session_id) }}">
            <i class="fas fa-arrow-left me-1"></i>Back
          </a>
        </div>
      </div>

      {% if not ecus %}
        <div class="empty-state">
          <i class="fas fa-microchip"></i>
          <h3>No ECUs Found</h3>
          <p>No ECUs are configured for this vehicle.</p>
        </div>
      {% else %}
        <div class="tile-grid">
          {% for e in ecus %}
          {% set ecu_code = (e.ecu_code if e is mapping else e) %}
          <a class="tile js-ecu-tile" 
             href="{{ url_for('tests_root', model=model_name, section='diagnostics', ecu=ecu_code, auto_run_session_id=_auto_run_session_id) }}"
             data-ecu-code="{{ ecu_code }}">
            
            <div class="left">
              <div class="d-flex align-items-center gap-3">
                {% if e is mapping and e.icon %}
                  {% set icon = e.icon %}
                  {% if icon.endswith('.svg') or icon.endswith('.png') or icon.endswith('.jpg') or icon.endswith('.jpeg') %}
                    <img src="{{ url_for('static', filename=icon) }}" alt="" class="tile-icon">
                  {% else %}
                    {% if icon.startswith("fa-") or " fa-" in icon or icon.startswith("fa ") %}
                      <i class="{{ icon }}" style="font-size: 1.2rem; color: var(--tvs-blue);"></i>
                    {% else %}
                      <span>{{ icon }}</span>
                    {% endif %}
                  {% endif %}
                {% endif %}
                
                <div>
                  <div class="title">
                    {{ (e.ecu_name if e is mapping and e.ecu_name else ecu_code) }}
                    <!-- ECU Status Dot (FIX-61) -->
                    <span class="ecu-status-dot unknown js-ecu-status" 
                          data-ecu-code="{{ ecu_code }}" 
                          style="display: none;"
                          title="ECU status unknown"></span>
                  </div>
                  
                  <div class="subtitle">
                    {% if e is mapping %}
                      {{ e.description or '' }}
                      {% if e.protocol or e.emission %}
                        <div class="small text-muted mt-1">
                          {% if e.protocol %}
                            <span class="badge-soft me-1">{{ e.protocol }}</span>
                          {% endif %}
                          {% if e.emission %}
                            <span class="badge-soft">{{ e.emission }}</span>
                          {% endif %}
                        </div>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">ECU Module</span>
                    {% endif %}
                  </div>
                  
                  <!-- ECU auto-run programs (FIX-60) -->
                  {% if e is mapping and e.auto_run_programs %}
                    <div class="small text-muted mt-2">
                      <i class="fas fa-play-circle me-1"></i>
                      {{ e.auto_run_programs|length }} ECU auto-run(s)
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="badges">
              <span class="badge-soft">ECU</span>
              {% if e is mapping and e.protocol %}
                <span class="badge-soft">{{ e.protocol }}</span>
              {% endif %}
            </div>
          </a>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ECU Status Polling Script (FIX-61, FIX-65) -->
{% if _auto_run_session_id %}
<script>
// ECU Status Polling for Colored Dots
const AUTO_RUN_SESSION_ID = "{{ _auto_run_session_id }}";

async function pollEcuStatus() {
    try {
        const response = await fetch(`/api/auto_run/${AUTO_RUN_SESSION_ID}/ecu_status`);
        const data = await response.json();
        
        if (data.ok && data.status) {
            // Update all ECU status dots
            data.status.forEach(stat => {
                const dots = document.querySelectorAll(`.js-ecu-status[data-ecu-code="${stat.ecu_code}"]`);
                dots.forEach(dot => {
                    dot.style.display = "inline-block";
                    dot.className = `ecu-status-dot ${stat.is_active ? 'active' : 'inactive'}`;
                    
                    // Format last response time
                    let title = `ECU ${stat.is_active ? 'Active' : 'Inactive'}`;
                    if (stat.last_response) {
                        const date = new Date(stat.last_response);
                        title += ` - Last response: ${date.toLocaleTimeString()}`;
                    }
                    if (stat.error_count > 0) {
                        title += ` (Errors: ${stat.error_count})`;
                    }
                    dot.title = title;
                });
            });
        }
    } catch (e) {
        console.error('Failed to poll ECU status:', e);
    }
}

// Poll every 2 seconds
if (AUTO_RUN_SESSION_ID) {
    pollEcuStatus();
    setInterval(pollEduStatus, 2000);
}
</script>
{% endif %}

<!-- ====================================================================== -->
<!-- PHASE 3 : PARAMETER SELECTION (Diagnostics) OR HEALTH TAB SELECTION -->
<!-- ====================================================================== -->
{% elif (section == "diagnostics" and ecu and not parameter) or (section == "vehicle_health" and not parameter) %}
<div class="row justify-content-center">
  <div class="col-11 col-xl-10">
    <div class="rounded-box card-shadow grid-wrap">
      <div class="grid-title">
        <div>
          <h5>
            {% if section == "diagnostics" %}
              <i class="fas fa-sliders-h me-2"></i>Select Parameter
            {% else %}
              <i class="fas fa-chart-bar me-2"></i>Select Health Tab
            {% endif %}
          </h5>
          <div class="subtle-muted">
            {{ model_name }}
            {% if section == "diagnostics" %} · ECU: <strong>{{ ecu }}</strong>{% endif %}
          </div>
          
          <!-- VIN Display (FIX-70) -->
          {% if _vin %}
            <div class="mt-2 vin-pill">
              <i class="fas fa-qrcode"></i>
              <span>VIN:</span>
              <span class="mono">{{ _vin }}</span>
            </div>
          {% endif %}
        </div>
        
        <div class="d-flex gap-2">
          {% if _auto_run_session_id %}
          <span class="badge bg-success">
            <i class="fas fa-play me-1"></i>Auto-run Active
          </span>
          {% endif %}
          
          {% if section == "diagnostics" %}
            <a class="btn btn-sm btn-outline-secondary" 
               href="{{ url_for('tests_root', model=model_name, section='diagnostics', auto_run_session_id=_auto_run_session_id) }}">
              <i class="fas fa-arrow-left me-1"></i>Back
            </a>
          {% else %}
            <a class="btn btn-sm btn-outline-secondary" 
               href="{{ url_for('tests_root', model=model_name, auto_run_session_id=_auto_run_session_id) }}">
              <i class="fas fa-arrow-left me-1"></i>Back
            </a>
          {% endif %}
        </div>
      </div>

      {% if section == "diagnostics" %}
        {% if not parameters %}
          <div class="empty-state">
            <i class="fas fa-sliders-h"></i>
            <h3>No Parameters Found</h3>
            <p>No parameters are configured for ECU <strong>{{ ecu }}</strong>.</p>
          </div>
        {% else %}
          <div class="tile-grid">
            {% for p in parameters %}
              {% set pcode = (p.parameter_code if p is mapping else p) %}
              {% set plabel = (p.label if p is mapping and p.label else pcode) %}
              {% set exec_class = (p.execution_class if p is mapping else None) %}
              
              <a class="tile" 
                 href="{{ url_for('tests_root', model=model_name, section='diagnostics', ecu=ecu, parameter=pcode, auto_run_session_id=_auto_run_session_id) }}">
                
                <div class="left">
                  <div class="d-flex align-items-center gap-3">
                    {% if p is mapping and p.icon %}
                      {% set icon = p.icon %}
                      {% if icon.endswith('.svg') or icon.endswith('.png') or icon.endswith('.jpg') or icon.endswith('.jpeg') %}
                        <img src="{{ url_for('static', filename=icon) }}" alt="" class="tile-icon">
                      {% else %}
                        {% if icon.startswith("fa-") or " fa-" in icon or icon.startswith("fa ") %}
                          <i class="{{ icon }}" style="font-size: 1.2rem; color: var(--tvs-blue);"></i>
                        {% else %}
                          <span>{{ icon }}</span>
                        {% endif %}
                      {% endif %}
                    {% endif %}
                    
                    <div>
                      <div class="title">{{ plabel }}</div>
                      <div class="subtitle">
                        {% if p is mapping and p.description %}{{ p.description }}{% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="badges">
                  {% if exec_class %}
                    {% set klass = exec_class|upper %}
                    {% if klass == 'STREAM' %}
                      <span class="badge-soft stream">
                        <i class="fas fa-sync fa-spin me-1"></i>STREAM
                      </span>
                    {% endif %}
                    {% if klass == 'SINGLE' %}
                      <span class="badge-soft single">
                        <i class="fas fa-play me-1"></i>SINGLE
                      </span>
                    {% endif %}
                    {% if klass == 'FLASH' %}
                      <span class="badge-soft flash">
                        <i class="fas fa-bolt me-1"></i>FLASH
                      </span>
                    {% endif %}
                    {% if klass == 'DUAL' %}
                      <span class="badge-soft dual">
                        <i class="fas fa-exchange-alt me-1"></i>DUAL
                      </span>
                    {% endif %}
                  {% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% endif %}
        
      {% else %} {# vehicle_health #}
        {% if not health_tabs %}
          <div class="empty-state">
            <i class="fas fa-chart-bar"></i>
            <h3>No Health Tabs Found</h3>
            <p>No Vehicle Health tabs are available for this vehicle.</p>
          </div>
        {% else %}
          <div class="tile-grid">
            {% for t in health_tabs %}
              {% set tcode = (t.folder_code if t is mapping else t) %}
              {% set tname = (t.folder_name if t is mapping and t.folder_name else tcode) %}
              {% set exec_class = (t.execution_class if t is mapping else None) %}
              
              <a class="tile" 
                 href="{{ url_for('tests_root', model=model_name, section='vehicle_health', parameter=tcode, auto_run_session_id=_auto_run_session_id) }}">
                
                <div class="left">
                  <div class="d-flex align-items-center gap-3">
                    {% if t is mapping and t.icon %}
                      {% set icon = t.icon %}
                      {% if icon.endswith('.svg') or icon.endswith('.png') or icon.endswith('.jpg') or icon.endswith('.jpeg') %}
                        <img src="{{ url_for('static', filename=icon) }}" alt="" class="tile-icon">
                      {% else %}
                        {% if icon.startswith("fa-") or " fa-" in icon or icon.startswith("fa ") %}
                          <i class="{{ icon }}" style="font-size: 1.2rem; color: var(--tvs-blue);"></i>
                        {% else %}
                          <span>{{ icon }}</span>
                        {% endif %}
                      {% endif %}
                    {% endif %}
                    
                    <div>
                      <div class="title">{{ tname }}</div>
                      <div class="subtitle">{{ t.description if t is mapping else '' }}</div>
                    </div>
                  </div>
                </div>
                
                <div class="badges">
                  {% if exec_class %}
                    {% if exec_class|upper == 'STREAM' %}
                      <span class="badge-soft stream">STREAM</span>
                    {% endif %}
                    {% if exec_class|upper == 'SINGLE' %}
                      <span class="badge-soft single">SINGLE</span>
                    {% endif %}
                  {% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- ====================================================================== -->
<!-- PHASE 4 : TEST SEQUENCE PAGE (FIX-62, FIX-64, FIX-70) -->
<!-- ====================================================================== -->
{% elif parameter %}
<div class="row justify-content-center">
  <div class="col-11 col-xl-12">

    <div class="seq-layout">
      <!-- Left Column - Tests -->
      <div class="rounded-box card-shadow">
        <div class="seq-header">
          <div>
            <div class="breadcrumbs">
              <a href="{{ url_for('tests_root', model=model_name, auto_run_session_id=_auto_run_session_id) }}" 
                 class="text-decoration-none">{{ model_name }}</a>
              <span class="mx-1">/</span>
              
              <a href="{{ url_for('tests_root', model=model_name, section=section, auto_run_session_id=_auto_run_session_id) }}" 
                 class="text-decoration-none">{{ section }}</a>
              
              {% if ecu %}
                <span class="mx-1">/</span>
                <a href="{{ url_for('tests_root', model=model_name, section='diagnostics', ecu=ecu, auto_run_session_id=_auto_run_session_id) }}" 
                   class="text-decoration-none">{{ ecu }}</a>
              {% endif %}
              
              <span class="mx-1">/</span>
              <strong>{{ parameter }}</strong>
            </div>
            
            <div class="subtle-muted small mt-2">
              <i class="fas fa-info-circle me-1"></i>
              Test Sequence Page (DB-authoritative tests)
            </div>
            
            <!-- VIN Display (FIX-70) -->
            {% if _vin %}
              <div class="mt-2 vin-pill">
                <i class="fas fa-qrcode"></i>
                <span>VIN:</span>
                <span class="mono">{{ _vin }}</span>
                <span class="badge bg-{{ 'success' if vin_source == 'auto' else 'warning' }} ms-1" 
                      style="font-size: 0.6rem;">
                  {{ vin_source|upper }}
                </span>
              </div>
            {% endif %}
          </div>

          <div class="d-flex gap-2 flex-wrap justify-content-end">
            {% if _auto_run_session_id %}
            <span class="badge bg-success">
              <i class="fas fa-play me-1"></i>Auto-run Active
            </span>
            {% endif %}
            
            {% if section == "diagnostics" and ecu %}
              <a class="btn btn-sm btn-outline-secondary" 
                 href="{{ url_for('tests_root', model=model_name, section='diagnostics', ecu=ecu, auto_run_session_id=_auto_run_session_id) }}">
                <i class="fas fa-arrow-left me-1"></i>Back
              </a>
            {% elif section == "vehicle_health" %}
              <a class="btn btn-sm btn-outline-secondary" 
                 href="{{ url_for('tests_root', model=model_name, section='vehicle_health', auto_run_session_id=_auto_run_session_id) }}">
                <i class="fas fa-arrow-left me-1"></i>Back
              </a>
            {% else %}
              <a class="btn btn-sm btn-outline-secondary" 
                 href="{{ url_for('tests_root', model=model_name, auto_run_session_id=_auto_run_session_id) }}">
                <i class="fas fa-arrow-left me-1"></i>Back
              </a>
            {% endif %}
          </div>
        </div>

        <!-- Stream Values Panel (FIX-62, FIX-64) -->
        {% if _auto_run_session_id and parameter in ['LIVE_PARAMETER', 'BATTERY_VOLTAGE'] %}
        <div class="stream-panel">
          <div class="header">
            <h6><i class="fas fa-wave-square me-2"></i>Live Stream Values</h6>
            <span class="badge" id="streamCount">0 signals</span>
          </div>
          
          <div id="streamValuesContainer">
            <div class="text-center text-muted py-4">
              <i class="fas fa-sync fa-spin me-2"></i>Waiting for stream data...
            </div>
          </div>
          
          <div class="stream-timestamp" id="streamTimestamp"></div>
        </div>
        {% endif %}

        <div class="seq-list">
          <!-- Control Buttons -->
          <div class="seq-controls mb-4 d-flex flex-wrap gap-2">
            <button id="btnRunAll" class="btn btn-sm btn-primary">
              <i class="fas fa-play me-1"></i>Run All
            </button>
            
            <button id="btnPause" class="btn btn-sm btn-outline-warning" disabled>
              <i class="fas fa-pause me-1"></i>Pause
            </button>
            
            <button id="btnResume" class="btn btn-sm btn-outline-secondary" disabled>
              <i class="fas fa-play me-1"></i>Resume
            </button>
            
            <button id="btnCancelAll" class="btn btn-sm btn-outline-danger" disabled>
              <i class="fas fa-stop me-1"></i>Cancel
            </button>

            <span id="dtcTopControls" class="ms-2"></span>
            <span id="iuprTopControls" class="ms-2"></span>
          </div>

          <!-- Tests Load Message -->
          <div id="testsLoadMessage" class="alert alert-info mb-3">
            <i class="fas fa-spinner fa-spin me-2"></i>Loading tests...
          </div>
          
          <!-- Test Sequence Container -->
          <div id="containerSequence"></div>
        </div>
      </div>

      <!-- Right Column - Live Log -->
      <div class="rounded-box card-shadow p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="fw-bold">
            <i class="fas fa-terminal me-2"></i>Live Log Preview
          </div>
          <div class="d-flex gap-2">
            <button id="btnClearLog" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-eraser me-1"></i>Clear
            </button>
            <button id="btnSaveLog" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-save me-1"></i>Save
            </button>
          </div>
        </div>
        
        <pre id="logArea" class="log-area" aria-live="polite"></pre>
        
        <div class="small text-muted mt-2 d-flex justify-content-between">
          <span>
            <i class="fas fa-list me-1"></i>
            <span id="logLineCount">0 lines</span>
          </span>
          <span>
            <i class="fas fa-tasks me-1"></i>
            <span id="activeTaskCount">0 active</span>
          </span>
          <span>
            <i class="fas fa-clock me-1"></i>
            <span id="logTimestamp"></span>
          </span>
        </div>
      </div>
    </div>

  </div>
</div>
{% endif %}
{% endif %}

<!-- ====================================================================== -->
<!-- MODALS (FIX-54, FIX-63) -->
<!-- ====================================================================== -->

<!-- Auto-Run Modal -->
<div class="modal fade" id="autoRunModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="autoRunTitle" class="modal-title">
          <i class="fas fa-play-circle me-2"></i>Running Pre-checks
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert flash-request" id="autoRunStatus">
          <i class="fas fa-spinner fa-spin me-2"></i>Starting auto-run programs...
        </div>

        <!-- Progress Bar -->
        <div class="progress-container mb-2">
          <div id="autoRunProgress" class="progress-bar-custom flash-request animated" style="width:0%"></div>
        </div>
        <div class="small text-muted mb-3 text-end">
          <span id="autoRunPercent">0</span>% complete
        </div>

        <!-- Programs List -->
        <div id="autoRunList" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button id="autoRunClose" class="btn btn-sm btn-outline-secondary" disabled>
          <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Manual VIN Modal (FIX-54, FIX-63) -->
<div class="modal fade" id="vinManualModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-qrcode me-2"></i>Enter VIN
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          VIN auto-read failed. Please enter VIN manually or scan QR/Barcode.
        </div>

        <label class="form-label fw-semibold">
          <i class="fas fa-barcode me-1"></i>VIN (17 characters)
        </label>
        <div class="input-group mb-2">
          <input id="vinManualInput" 
                 class="form-control font-monospace" 
                 maxlength="17" 
                 placeholder="e.g. MA1XXXX..."
                 autocomplete="off"
                 pattern="[A-HJ-NPR-Z0-9]{17}"
                 title="VIN must be 17 characters (letters and numbers, excluding I,O,Q)">
          <button id="vinScanBtn" class="btn btn-outline-secondary" type="button">
            <i class="fas fa-camera me-1"></i>Scan
          </button>
        </div>
        
        <div class="form-text">
          <i class="fas fa-info-circle me-1"></i>
          VIN excludes letters I, O, Q. Auto-uppercase.
        </div>

        <div id="vinManualError" class="alert alert-danger mt-3" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button id="vinManualSubmit" class="btn btn-sm btn-primary">
          <i class="fas fa-check me-1"></i>Submit
        </button>
        <button id="vinManualCancel" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scan Modal (Unified Scanner - FIX-80 through FIX-88) -->
<div class="modal fade" id="scanModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-camera me-2"></i>Scan QR / Barcode
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="scanStatus" class="alert flash-request">
          <i class="fas fa-spinner fa-spin me-2"></i>Starting scanner...
        </div>
        
        <div class="small text-muted mb-3">
          <i class="fas fa-info-circle me-1"></i>
          Point the camera at the QR/Barcode. The value will auto-fill the field.
        </div>

        <!-- HTML5 QR Reader Container -->
        <div id="readerWrap" style="display:none;">
          <div id="reader" style="width:100%; max-width:320px; margin:0 auto;"></div>
        </div>

        <!-- Backend Scanner Hint -->
        <div id="backendNoPreviewHint" class="small text-muted mt-2" style="display:none;">
          <i class="fas fa-camera me-1"></i>
          Using station backend scanner (OpenCV). Live preview not available in browser.
        </div>
      </div>
      <div class="modal-footer">
        <button id="scanCancelBtn" class="btn btn-sm btn-outline-danger">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- WDI / Generic Input Modal -->
<div class="modal fade" id="wdiInputModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="wdiModalTitle" class="modal-title">
          <i class="fas fa-edit me-2"></i>Inputs
        </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="wdiModalInfo" class="mb-3"></div>
        
        <form id="wdiInputForm">
          <div id="wdiInputContainer"></div>
        </form>
        
        <div class="d-flex gap-2 mb-3">
          <button id="setDefaultBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-undo me-1"></i>Set Default Values
          </button>
          <button id="validateInputsBtn" class="btn btn-outline-info btn-sm">
            <i class="fas fa-check-circle me-1"></i>Validate
          </button>
        </div>
        
        <div id="wdiModalStatus" class="alert" style="display:none;"></div>
        <div id="wdiValidationErrors" class="alert alert-danger" style="display:none;"></div>

        <div id="wdiLogSection" class="mt-3" style="display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold small">
              <i class="fas fa-terminal me-1"></i>Live Execution Log
            </div>
            <button id="wdiClearLog" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-eraser me-1"></i>Clear
            </button>
          </div>
          <pre id="wdiLogArea" class="log-area-mini"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button id="wdiSubmitBtn" class="btn btn-primary btn-sm">
          <i class="fas fa-play me-1"></i>Submit
        </button>
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Flashing Input Modal -->
<div class="modal fade" id="flashingInputModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="flashingInputTitle" class="modal-title">
          <i class="fas fa-bolt me-2"></i>Flashing Parameters
        </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="flashingInputInfo" class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Provide required inputs. Backend enforces flashing safety rules.
        </div>
        <div id="flashingInputFields"></div>
        <div id="flashingInputErrors" class="alert alert-danger mt-2" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button id="flashingInputSubmit" class="btn btn-primary btn-sm">
          <i class="fas fa-play me-1"></i>Start Flashing
        </button>
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toggle Status Modal -->
<div class="modal fade" id="toggleStatusModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="toggleModalTitle" class="modal-title">
          <i class="fas fa-info-circle me-2"></i>Status
        </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="toggleStatus" class="flash-request p-3 rounded mb-3">
          <strong>Processing...</strong>
          <div class="small mt-1">Please wait</div>
        </div>

        <div id="toggleLogSection" style="display:none;">
          <div class="fw-bold small mb-2 text-start">
            <i class="fas fa-terminal me-1"></i>Live Log
          </div>
          <pre id="toggleLogArea" class="log-area-mini text-start"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Flashing Progress Modal -->
<div class="modal fade" id="flashingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="flashingModalTitle" class="modal-title">
          <i class="fas fa-bolt me-2"></i>ECU Flashing
        </h5>
      </div>
      <div class="modal-body text-center">
        <div id="flashingStatus" class="flash-start p-3 rounded mb-3">
          <strong>Flashing Started</strong>
          <div class="small">Please do not disconnect...</div>
        </div>

        <div class="mb-3">
          <div class="progress-container">
            <div id="flashingProgress" class="progress-bar-custom flash-start animated" style="width:0%"></div>
          </div>
          <div class="small mt-1"><span id="flashingPercent">0</span>%</div>
        </div>

        <pre id="flashingLog" class="log-area" style="height:160px;"></pre>
      </div>
      <div class="modal-footer">
        <button id="flashingCancel" class="btn btn-outline-danger btn-sm">
          <i class="fas fa-stop me-1"></i>Emergency Stop
        </button>
        <button id="flashingClose" class="btn btn-outline-secondary btn-sm" disabled data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-circle me-2"></i>Error
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="errorMessage"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- ====================================================================== -->
<!-- TESTS PAGE JAVASCRIPT (FIX-31, FIX-36, FIX-60, FIX-61, FIX-62, FIX-63, FIX-64, FIX-65, FIX-70) -->
<!-- ====================================================================== -->

{% if model_name and _auto_run_session_id %}
<script>
// ECU Status Polling (FIX-61, FIX-65)
const AUTO_RUN_SESSION_ID = "{{ _auto_run_session_id }}";

async function pollEcuStatus() {
    try {
        const response = await fetch(`/api/auto_run/${AUTO_RUN_SESSION_ID}/ecu_status`);
        const data = await response.json();
        
        if (data.ok && data.status) {
            data.status.forEach(stat => {
                const dots = document.querySelectorAll(`.js-ecu-status[data-ecu-code="${stat.ecu_code}"]`);
                dots.forEach(dot => {
                    dot.style.display = "inline-block";
                    dot.className = `ecu-status-dot ${stat.is_active ? 'active' : 'inactive'}`;
                    
                    let title = `ECU ${stat.is_active ? 'Active' : 'Inactive'}`;
                    if (stat.last_response) {
                        const date = new Date(stat.last_response);
                        title += ` - Last response: ${date.toLocaleTimeString()}`;
                    }
                    dot.title = title;
                });
            });
        }
    } catch (e) {
        console.error('Failed to poll ECU status:', e);
    }
}

// Poll every 2 seconds
if (AUTO_RUN_SESSION_ID) {
    pollEcuStatus();
    setInterval(pollEcuStatus, 2000);
}
</script>
{% endif %}

{% if model_name and not section and not parameter %}
<!-- SECTION PAGE SCRIPT - Auto-run handling (FIX-36, FIX-60, FIX-63) -->
<script>
(function(){
    // Track auto-run state per login (FIX-36)
    let autoRunStarted = false;
    let autoRunSessionId = "{{ _auto_run_session_id }}" || null;
    const loginId = '{{ session.user.login_id if session.user.login_id else "" }}';
    const storageKey = `nirix_auto_run_${loginId}`;
    
    // Check sessionStorage for existing session
    if (!autoRunSessionId && loginId) {
        autoRunSessionId = sessionStorage.getItem(storageKey);
    }

    async function apiGetJSON(url){
        const r = await fetch(url);
        return await r.json();
    }

    async function apiRunAutoPrograms(section){
        // Don't run if already started (FIX-36)
        if (autoRunStarted || autoRunSessionId) {
            console.log('Auto-run already started for this login session');
            return { ok: false, error: 'ALREADY_RUNNING', session_id: autoRunSessionId };
        }
        
        const res = await fetch("/api/run_auto_programs", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ 
                vehicle_name: "{{ model_name }}", 
                section,
                user_login_id: loginId
            })
        });
        
        const data = await res.json();
        
        if (data.ok) {
            autoRunStarted = true;
            autoRunSessionId = data.session_id;
            if (loginId) {
                sessionStorage.setItem(storageKey, data.session_id);
            }
        } else if (data.error === 'AUTO_RUN_ALREADY_ACTIVE' && data.session_id) {
            // Recover existing session
            autoRunStarted = true;
            autoRunSessionId = data.session_id;
            sessionStorage.setItem(storageKey, data.session_id);
            return { ok: true, session_id: data.session_id, programs: data.programs };
        }
        
        return data;
    }

    async function apiAutoRunStatus(sessionId){
        const res = await fetch(`/api/auto_run/${encodeURIComponent(sessionId)}/status`);
        return await res.json();
    }

    async function apiSubmitManualVin(session_id, program_id, vin){
        const res = await fetch("/api/auto_run/vin", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ session_id, program_id, vin })
        });
        return await res.json();
    }

    // Scan functions (FIX-80 through FIX-88)
    async function apiScanStart(kind="text", timeout_sec=25){
        const res = await fetch("/api/scan/start", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ kind, timeout_sec })
        });
        return await res.json();
    }
    
    async function apiScanStatus(scanId){
        return await apiGetJSON(`/api/scan/${encodeURIComponent(scanId)}/status`);
    }
    
    async function apiScanCancel(scanId){
        await fetch(`/api/scan/${encodeURIComponent(scanId)}/cancel`, {method:"POST"});
        return true;
    }

    // Unified scan function (FIX-80)
    async function scanAndFillInput(targetInputId, scanKind="text"){
        const input = document.getElementById(targetInputId);
        if (!input) return;

        const modalEl = document.getElementById("scanModal");
        const modal = new bootstrap.Modal(modalEl);
        const statusEl = document.getElementById("scanStatus");
        const cancelBtn = document.getElementById("scanCancelBtn");
        const readerWrap = document.getElementById("readerWrap");
        const readerDiv = document.getElementById("reader");
        const noPreviewHint = document.getElementById("backendNoPreviewHint");

        readerWrap.style.display = "none";
        noPreviewHint.style.display = "none";
        readerDiv.innerHTML = "";

        // Try HTML5 QR first
        if (window.Html5Qrcode){
            statusEl.className = "alert flash-request";
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Opening camera...';
            readerWrap.style.display = "block";
            modal.show();

            const html5QrCode = new Html5Qrcode("reader");
            let stopRequested = false;

            async function cleanup(){
                stopRequested = true;
                try { await html5QrCode.stop(); } catch(e){}
                try { await html5QrCode.clear(); } catch(e){}
                readerDiv.innerHTML = "";
            }

            cancelBtn.onclick = async () => { await cleanup(); modal.hide(); };

            function onScanSuccess(decodedText){
                if (stopRequested) return;
                input.value = decodedText || "";
                input.dispatchEvent(new Event("input", {bubbles:true}));
                input.dispatchEvent(new Event("blur", {bubbles:true}));
                cleanup().finally(() => modal.hide());
            }

            try{
                const devices = await Html5Qrcode.getCameras();
                if (!devices || !devices.length) throw new Error("No camera devices found");

                const backCam = devices.find(d => {
                    const lbl = (d.label || "").toLowerCase();
                    return lbl.includes("back") || lbl.includes("rear") || lbl.includes("environment");
                });
                const cameraId = (backCam ? backCam.id : devices[0].id);

                statusEl.innerHTML = '<i class="fas fa-camera me-2"></i>Point camera at QR/Barcode...';
                await html5QrCode.start(
                    cameraId,
                    { fps: 12, qrbox: 240 },
                    onScanSuccess,
                    () => {}
                );
                return;
            }catch(e){
                console.warn("html5-qrcode failed; fallback to backend:", e);
                try { await cleanup(); } catch(_){}
                readerWrap.style.display = "none";
            }
        }

        // Backend scan fallback
        statusEl.className = "alert flash-request";
        statusEl.innerHTML = '<i class="fas fa-camera me-2"></i>Starting station scanner...';
        noPreviewHint.style.display = "block";
        modal.show();

        try {
            const start = await apiScanStart(scanKind, 25);
            if (!start.ok) throw new Error(start.error || "Failed to start scan");

            const scanId = start.scan_id;
            let timer = setInterval(async () => {
                try {
                    const st = await apiScanStatus(scanId);
                    if (!st.ok) return;

                    if (st.status === "found"){
                        clearInterval(timer);
                        modal.hide();
                        input.value = st.value || "";
                        input.dispatchEvent(new Event("input", {bubbles:true}));
                        input.dispatchEvent(new Event("blur", {bubbles:true}));
                        return;
                    }

                    if (["timeout","cancelled","error","busy"].includes(st.status)){
                        clearInterval(timer);
                        statusEl.className = "alert flash-fail";
                        statusEl.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${st.error || `Scan ${st.status}`}`;
                    }
                } catch(e) {}
            }, 250);

            cancelBtn.onclick = async () => {
                clearInterval(timer);
                await apiScanCancel(scanId);
                modal.hide();
            };
        } catch(e) {
            statusEl.className = "alert flash-fail";
            statusEl.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${e.message}`;
        }
    }

    function setAutoRunUI({title, statusClass, statusText, percent, itemsHtml, closable}){
        document.getElementById('autoRunTitle').innerHTML = `<i class="fas fa-play-circle me-2"></i>${title || "Running Pre-checks"}`;
        const st = document.getElementById('autoRunStatus');
        st.className = `alert ${statusClass || 'flash-request'}`;
        st.innerHTML = statusText ? `<i class="fas fa-${statusClass === 'flash-success' ? 'check-circle' : 'info-circle'} me-2"></i>${statusText}` : '';
        document.getElementById('autoRunProgress').style.width = `${percent || 0}%`;
        document.getElementById('autoRunPercent').textContent = String(percent || 0);
        document.getElementById('autoRunList').innerHTML = itemsHtml || "";
        document.getElementById('autoRunClose').disabled = !closable;
    }

    function openVinModal({onSubmit, onCancel}){
        const modalEl = document.getElementById("vinManualModal");
        const modal = new bootstrap.Modal(modalEl);
        const input = document.getElementById("vinManualInput");
        const err = document.getElementById("vinManualError");
        const btnSubmit = document.getElementById("vinManualSubmit");
        const btnCancel = document.getElementById("vinManualCancel");
        const btnScan = document.getElementById("vinScanBtn");

        err.style.display = "none";
        err.innerHTML = "";
        input.value = "";
        input.classList.remove("is-valid", "is-invalid");

        // Auto-uppercase and filter invalid chars
        input.addEventListener("input", (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[IOQ]/g, '');
        });

        btnScan.onclick = () => scanAndFillInput("vinManualInput", "vin");

        btnSubmit.onclick = async () => {
            err.style.display = "none";
            const vin = (input.value || "").trim().toUpperCase();

            if (vin.length !== 17){
                err.style.display = "block";
                err.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>VIN must be 17 characters (got ${vin.length})`;
                input.classList.add("is-invalid");
                return;
            }
            if (/[IOQ]/.test(vin)){
                err.style.display = "block";
                err.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>VIN contains invalid characters (I, O, Q)`;
                input.classList.add("is-invalid");
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            
            try{
                await onSubmit(vin);
                modal.hide();
            }catch(e){
                err.style.display = "block";
                err.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${e?.message || "Failed to submit VIN"}`;
            }finally{
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="fas fa-check me-1"></i>Submit';
            }
        };

        btnCancel.onclick = () => {
            modal.hide();
            if (onCancel) onCancel();
        };

        modal.show();
    }

    function isStreamProgram(p){
        return String(p.program_type || "").toLowerCase() === "stream";
    }

    function deriveProgramUiStatus(p, liveTaskStatus){
        const taskStatus = (liveTaskStatus?.status || "NOT_FOUND");

        if (["PENDING","RUNNING"].includes(taskStatus)){
            return isStreamProgram(p) ? "STREAMING" : "RUNNING";
        }
        if (taskStatus === "PAUSED"){
            return isStreamProgram(p) ? "STREAMING" : "PAUSED";
        }
        if (["COMPLETED","CANCELLED","TIMEOUT","ERROR"].includes(taskStatus)){
            return taskStatus;
        }
        return (p.task_id ? "NOT_FOUND" : "NOT_STARTED");
    }

    function renderBadge(uiStatus, passed){
        if (uiStatus === "STREAMING") 
            return `<span class="badge bg-info"><i class="fas fa-sync fa-spin me-1"></i>STREAMING</span>`;
        if (uiStatus === "RUNNING")   
            return `<span class="badge bg-warning text-dark"><i class="fas fa-spinner fa-spin me-1"></i>RUNNING</span>`;
        if (uiStatus === "PAUSED")    
            return `<span class="badge bg-secondary"><i class="fas fa-pause me-1"></i>PAUSED</span>`;
        if (uiStatus === "NOT_STARTED") 
            return `<span class="badge bg-light text-dark">NOT STARTED</span>`;
        if (uiStatus === "NOT_FOUND") 
            return `<span class="badge bg-secondary">TASK LOST</span>`;
        if (uiStatus === "ERROR" || uiStatus === "TIMEOUT") 
            return `<span class="badge bg-danger"><i class="fas fa-exclamation-circle me-1"></i>FAIL</span>`;
        if (uiStatus === "CANCELLED") 
            return `<span class="badge bg-secondary"><i class="fas fa-ban me-1"></i>CANCELLED</span>`;
        if (uiStatus === "COMPLETED") {
            return passed 
                ? `<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>PASS</span>` 
                : `<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>FAIL</span>`;
        }
        return `<span class="badge bg-light text-dark">${uiStatus}</span>`;
    }

    function renderValueWithLimits(value, limits) {
        if (!limits || !limits.length) return value;
        
        let isWithin = true;
        for (const lim of limits) {
            if (lim.signal === 'battery_voltage' && lim.lsl && lim.usl) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    isWithin = num >= lim.lsl && num <= lim.usl;
                }
            }
        }
        
        const colorClass = isWithin ? 'text-success' : 'text-danger';
        return `<span class="${colorClass} fw-bold">${value}</span>`;
    }

    async function runDiagnosticsPrechecksThenNavigate(href){
        // Don't run if already started (FIX-36)
        if (autoRunStarted && autoRunSessionId) {
            console.log('Using existing auto-run session:', autoRunSessionId);
            
            const status = await apiAutoRunStatus(autoRunSessionId);
            if (status.ok && status.status !== 'failed' && status.status !== 'completed') {
                const nextUrl = new URL(href, window.location.origin);
                nextUrl.searchParams.set("auto_run_session_id", autoRunSessionId);
                window.location.href = nextUrl.toString();
                return;
            } else {
                autoRunStarted = false;
                autoRunSessionId = null;
                sessionStorage.removeItem(storageKey);
            }
        }

        const modalEl = document.getElementById('autoRunModal');
        const modal = new bootstrap.Modal(modalEl);

        setAutoRunUI({
            title: "Diagnostics – Pre-checks",
            statusClass: "flash-request",
            statusText: "Starting pre-check programs...",
            percent: 0,
            itemsHtml: "",
            closable: false
        });
        modal.show();

        let start;
        try{
            start = await apiRunAutoPrograms("diagnostics");
        }catch(e){
            setAutoRunUI({
                title: "Diagnostics – Pre-checks Failed",
                statusClass: "flash-fail",
                statusText: "Auto-run API failed. Cannot enter Diagnostics.",
                percent: 0,
                itemsHtml: "",
                closable: true
            });
            document.getElementById('autoRunClose').onclick = () => modal.hide();
            return;
        }

        if (!start || start.ok !== true){
            if (start.error === 'AUTO_RUN_ALREADY_ACTIVE' && start.session_id) {
                // Session exists, use it
                const nextUrl = new URL(href, window.location.origin);
                nextUrl.searchParams.set("auto_run_session_id", start.session_id);
                window.location.href = nextUrl.toString();
                return;
            }
            
            setAutoRunUI({
                title: "Diagnostics – Pre-checks Failed",
                statusClass: "flash-fail",
                statusText: start?.error || "Auto-run failed",
                percent: 0,
                itemsHtml: "",
                closable: true
            });
            document.getElementById('autoRunClose').onclick = () => modal.hide();
            return;
        }

        const sessionId = start.session_id || null;
        const programs = Array.isArray(start.programs) ? start.programs : [];

        if (!sessionId){
            setAutoRunUI({
                title: "Diagnostics – Pre-checks Failed",
                statusClass: "flash-fail",
                statusText: "No session_id returned by server.",
                percent: 0,
                itemsHtml: "",
                closable: true
            });
            document.getElementById('autoRunClose').onclick = () => modal.hide();
            return;
        }

        // Store session
        autoRunStarted = true;
        autoRunSessionId = sessionId;
        if (loginId) {
            sessionStorage.setItem(storageKey, sessionId);
        }

        // No programs configured => allow navigation
        if (!programs.length){
            modal.hide();
            window.location.href = href;
            return;
        }

        const state = programs.map(p => ({
            program_id: p.program_id,
            program_name: p.program_name || p.program_id,
            program_type: p.program_type || "single",
            source: p.source || "section",
            required: (p.required ?? p.is_required ?? true) === true,
            fallback_action: String(p.fallback_action || "none"),
            fallback_input: p.fallback_input || null,
            log_as_vin: p.log_as_vin === true,
            display_type: p.display_type || "text",
            display_label: p.display_label || "",
            display_unit: p.display_unit || null,
            output_limits: p.output_limits || [],
            task_id: null,
            ui_status: "NOT_STARTED",
            passed: null,
            exception: null,
            result_value: null
        }));

        const vinPrompted = new Set();
        let vinModalOpen = false;

        function renderList(){
            return `
                <div class="mt-2">
                    ${state.map(p => {
                        const req = p.required
                            ? `<span class="badge bg-secondary ms-1">Required</span>`
                            : `<span class="badge bg-light text-dark ms-1">Optional</span>`;

                        const badge = renderBadge(p.ui_status, p.passed === true);
                        const sourceBadge = p.source === 'ecu' 
                            ? `<span class="badge bg-info ms-1">ECU</span>`
                            : `<span class="badge bg-primary ms-1">Section</span>`;

                        const err = (p.exception && p.passed === false)
                            ? `<div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>${p.exception}</div>`
                            : ``;

                        let rv = '';
                        if (p.result_value && p.passed) {
                            if (p.display_type === 'value' && p.display_unit) {
                                const valueHtml = renderValueWithLimits(p.result_value, p.output_limits);
                                rv = `<div class="small text-muted mt-1">Value: ${valueHtml} ${p.display_unit}</div>`;
                            } else {
                                rv = `<div class="small text-muted mt-1">Value: <span class="font-monospace">${p.result_value}</span></div>`;
                            }
                        }

                        const isVin = (p.log_as_vin === true && p.fallback_action.toLowerCase() === "manual_input");
                        const manualBtn = isVin
                            ? `<button type="button"
                                       class="btn btn-sm btn-outline-primary mt-2"
                                       data-program-id="${p.program_id}">
                                   <i class="fas fa-keyboard me-1"></i>Manual VIN
                               </button>`
                            : ``;

                        return `
                            <div class="auto-run-program-item ${p.ui_status.toLowerCase()}">
                                <div class="d-flex justify-content-between align-items-center gap-2">
                                    <div>
                                        <strong>${p.program_name}</strong>
                                        ${sourceBadge}
                                        <span class="text-muted ms-1">(${p.program_id})</span>
                                    </div>
                                    <div>${badge}${req}</div>
                                </div>
                                ${rv}
                                ${err}
                                ${manualBtn}
                            </div>
                        `;
                    }).join("")}
                </div>
            `;
        }

        // Manual VIN button handler
        document.getElementById("autoRunList").onclick = (ev) => {
            const btn = ev.target.closest(".btn[data-program-id]");
            if (!btn) return;

            const pid = btn.dataset.programId;
            const prog = state.find(x => x.program_id === pid);
            if (!prog) return;

            if (vinModalOpen) return;
            vinModalOpen = true;

            openVinModal({
                onSubmit: async (vin) => {
                    const resp = await apiSubmitManualVin(sessionId, pid, vin);
                    if (!resp.ok) throw new Error(resp.error || "VIN_SUBMIT_FAILED");
                    prog.passed = true;
                    prog.result_value = vin;
                    prog.exception = null;
                    
                    // Update VIN display
                    const vinDisplay = document.getElementById('vinValue');
                    if (vinDisplay) {
                        vinDisplay.textContent = vin;
                    }
                },
                onCancel: () => {}
            });

            setTimeout(() => { vinModalOpen = false; }, 700);
        };

        // Poll session status
        const timer = setInterval(async () => {
            let st;
            try{
                st = await apiAutoRunStatus(sessionId);
            }catch(e){
                clearInterval(timer);
                setAutoRunUI({
                    title: "Diagnostics – Pre-checks Failed",
                    statusClass: "flash-fail",
                    statusText: "Failed to fetch auto-run status.",
                    percent: 0,
                    itemsHtml: renderList(),
                    closable: true
                });
                document.getElementById('autoRunClose').onclick = () => modal.hide();
                return;
            }

            if (!st || st.ok !== true){
                clearInterval(timer);
                setAutoRunUI({
                    title: "Diagnostics – Pre-checks Failed",
                    statusClass: "flash-fail",
                    statusText: st?.error || "Auto-run status failed",
                    percent: 0,
                    itemsHtml: renderList(),
                    closable: true
                });
                document.getElementById('autoRunClose').onclick = () => modal.hide();
                return;
            }

            const results = st.results || {};
            const taskIds = st.task_ids || {};
            const live = st.live_task_statuses || {};

            // Update state
            for (const p of state){
                p.task_id = taskIds[p.program_id] || p.task_id;
                const liveTask = live[p.program_id] || null;
                p.ui_status = deriveProgramUiStatus(p, liveTask);

                const pr = results[p.program_id] || null;
                if (pr){
                    p.passed = !!pr.passed;
                    p.exception = pr.error_message || null;
                    p.result_value = pr.result_value || null;
                } else {
                    if (isStreamProgram(p) && p.ui_status === "STREAMING"){
                        p.passed = true;
                    } else if (p.ui_status === "NOT_STARTED" || p.ui_status === "RUNNING") {
                        p.passed = null;
                    }
                }
            }

            // Calculate progress
            const singles = state.filter(p => !isStreamProgram(p));
            const doneSingles = singles.filter(p => ["COMPLETED","ERROR","TIMEOUT","CANCELLED"].includes(p.ui_status)).length;
            const percent = singles.length ? Math.round((doneSingles / singles.length) * 100) : 100;

            setAutoRunUI({
                title: "Diagnostics – Pre-checks",
                statusClass: "flash-request",
                statusText: "Running pre-check programs...",
                percent,
                itemsHtml: renderList(),
                closable: false
            });

            // Auto-open VIN modal if needed
            if (st.vin_input_needed === true){
                const vinProg = state.find(p => p.log_as_vin && p.fallback_action.toLowerCase() === "manual_input");
                if (vinProg && !vinPrompted.has(vinProg.program_id) && !vinModalOpen){
                    vinPrompted.add(vinProg.program_id);
                    vinModalOpen = true;

                    openVinModal({
                        onSubmit: async (vin) => {
                            const resp = await apiSubmitManualVin(sessionId, vinProg.program_id, vin);
                            if (!resp.ok) throw new Error(resp.error || "VIN_SUBMIT_FAILED");
                            vinProg.passed = true;
                            vinProg.result_value = vin;
                            vinProg.exception = null;
                        },
                        onCancel: () => {}
                    });

                    setTimeout(() => { vinModalOpen = false; }, 700);
                    return;
                }
            }

            // Check blocking programs
            if (Array.isArray(st.blocking_programs) && st.blocking_programs.length){
                clearInterval(timer);
                setAutoRunUI({
                    title: "Diagnostics – Pre-checks Failed",
                    statusClass: "flash-fail",
                    statusText: `Blocked by: ${st.blocking_programs.join(", ")}`,
                    percent,
                    itemsHtml: renderList(),
                    closable: true
                });
                document.getElementById('autoRunClose').onclick = () => modal.hide();
                return;
            }

            if (st.all_required_passed === true){
                clearInterval(timer);
                setAutoRunUI({
                    title: "Diagnostics – Pre-checks Passed",
                    statusClass: "flash-success",
                    statusText: "All required pre-checks passed. Entering Diagnostics...",
                    percent: 100,
                    itemsHtml: renderList(),
                    closable: false
                });

                const nextUrl = new URL(href, window.location.origin);
                nextUrl.searchParams.set("auto_run_session_id", sessionId);

                setTimeout(() => {
                    modal.hide();
                    window.location.href = nextUrl.toString();
                }, 1000);
            }

        }, 700);

        document.getElementById('autoRunClose').onclick = () => modal.hide();
    }

    // Attach click handlers
    document.querySelectorAll(".js-section-tile").forEach(a => {
        const stype = (a.dataset.sectionType || "").toLowerCase();
        if (stype !== "diagnostics") return;

        a.addEventListener("click", (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            
            a.style.pointerEvents = 'none';
            runDiagnosticsPrechecksThenNavigate(a.href).finally(() => {
                setTimeout(() => {
                    a.style.pointerEvents = '';
                }, 2000);
            });
        });
    });
})();
</script>
{% endif %}

{% if model_name and section == "diagnostics" and ecu and not parameter %}
<!-- ECU PAGE SCRIPT - ECU-level auto-run (FIX-60) -->
<script>
(function(){
    const AUTO_RUN_SESSION_ID = "{{ _auto_run_session_id }}";
    
    async function apiRunEcuAutoRun() {
        if (AUTO_RUN_SESSION_ID) {
            console.log('ECU page loaded with session:', AUTO_RUN_SESSION_ID);
            // ECU status will be polled by the global script
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        apiRunEcuAutoRun();
    });
})();
</script>
{% endif %}

{% if model_name and parameter %}
<!-- TEST SEQUENCE PAGE SCRIPT (FIX-62, FIX-64, FIX-70) -->
<script>
// ===========================================================================
// TEST SEQUENCE PAGE JAVASCRIPT
// ===========================================================================

const SERVER_TESTS_RAW = {{ (tests or []) | tojson }};
const AUTO_RUN_SESSION_ID = "{{ _auto_run_session_id|default('') }}";
const VIN_VALUE = "{{ current_vin|default('') }}";
const VIN_SOURCE = "{{ current_vin_source|default('none') }}";

const MODEL_NAME = "{{ model_name }}";
const SECTION = "{{ section }}";
const ECU = "{{ ecu or '' }}";
const PARAMETER_RAW = "{{ parameter }}";

let TESTS = [];
let PAGE_TYPE = null;

let activeTaskIds = new Set();
let perTaskLogTimers = new Map();
let logLineCount = 0;
let globalPaused = false;
let userCancelledTaskIds = new Set();

const LOG_MAX_CHARS = 2_000_000;

// Stream values polling
let streamPollInterval = null;
let lastStreamUpdate = null;

// ===================== UI helpers =====================
function setLoadMessage(type, text){
    const box = document.getElementById("testsLoadMessage");
    if (!box) return;
    box.className = `alert alert-${type} mb-3`;
    box.innerHTML = text;
    box.style.display = "block";
}

function hideLoadMessage(){
    const box = document.getElementById("testsLoadMessage");
    if (!box) return;
    box.style.display = "none";
}

function updateLogStats(){
    const lc = document.getElementById("logLineCount");
    const tc = document.getElementById("activeTaskCount");
    const ts = document.getElementById("logTimestamp");
    
    if (lc) lc.textContent = `${logLineCount} lines`;
    if (tc) tc.textContent = `${activeTaskIds.size} active`;
    if (ts) ts.textContent = new Date().toLocaleTimeString();
}

function appendLogLine(line, targetAreaId = "logArea"){
    if (!line) return;
    const area = document.getElementById(targetAreaId);
    if (!area) return;
    area.textContent += line + "\n";
    if (targetAreaId === "logArea") {
        if (area.textContent.length > LOG_MAX_CHARS) {
            area.textContent = area.textContent.slice(-LOG_MAX_CHARS);
        }
        logLineCount++;
        updateLogStats();
    }
    area.scrollTop = area.scrollHeight;
}

function showError(message){
    document.getElementById("errorMessage").textContent = message;
    new bootstrap.Modal(document.getElementById("errorModal")).show();
}

// ===================== Normalize helpers =====================
function normKey(s){
    return String(s || "").trim().replace(/\s+/g, " ").toLowerCase();
}

function candidateCodes(raw){
    const s = String(raw || "").trim();
    const noSpace = s.replace(/\s+/g, "_");
    const upper = noSpace.toUpperCase();
    const lower = noSpace.toLowerCase();
    return Array.from(new Set([s, noSpace, upper, lower]));
}

// ===================== API =====================
async function apiGetJSON(url){
    const r = await fetch(url);
    return await r.json();
}

async function apiFetchTests(vehicle, section, ecu, parameter){
    const qs = new URLSearchParams();
    qs.set("vehicle_name", vehicle);
    qs.set("section", section);
    qs.set("parameter", parameter);
    if (section === "diagnostics" && ecu) qs.set("ecu", ecu);
    const data = await apiGetJSON(`/api/tests?${qs.toString()}`);
    return Array.isArray(data.tests) ? data.tests : [];
}

async function apiRunTest(testId, user_inputs = {}){
    const payload = { vehicle_name: MODEL_NAME, test_id: String(testId), user_inputs: user_inputs || {} };
    const res = await fetch("/api/run_test", { 
        method: "POST", 
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload) 
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "RUN_FAILED");
    return data.task_id;
}

async function apiTaskStatus(taskId){ 
    return await apiGetJSON(`/api/task/${taskId}/status`); 
}

async function apiTaskLogs(taskId){
    const d = await apiGetJSON(`/api/task/${taskId}/logs`);
    return d.log_text || "";
}

async function apiCancel(taskId){ 
    await fetch(`/api/task/${taskId}/cancel`, {method:"POST"}); 
    return true; 
}

async function apiPause(taskId){ 
    await fetch(`/api/task/${taskId}/pause`, {method:"POST"}); 
    return true; 
}

async function apiResume(taskId){ 
    await fetch(`/api/task/${taskId}/resume`, {method:"POST"}); 
    return true; 
}

// Stream values API (FIX-64)
async function apiGetStreamValues(sessionId){
    return await apiGetJSON(`/api/auto_run/${encodeURIComponent(sessionId)}/stream_values`);
}

// ===================== Resolve parameter code =====================
async function resolveParameterCode(){
    if (SECTION === "diagnostics" && ECU){
        const data = await apiGetJSON(`/api/parameters/${encodeURIComponent(MODEL_NAME)}/${encodeURIComponent(ECU)}`);
        const params = Array.isArray(data.parameters) ? data.parameters : [];
        const rawKey = normKey(PARAMETER_RAW);

        for (const p of params){
            if (normKey(p.parameter_code) === rawKey) return p.parameter_code;
            if (normKey(p.label) === rawKey) return p.parameter_code;
        }

        const cands = candidateCodes(PARAMETER_RAW).map(normKey);
        for (const p of params){
            if (cands.includes(normKey(p.parameter_code)) || cands.includes(normKey(p.label))) return p.parameter_code;
        }

        return PARAMETER_RAW;
    }

    if (SECTION === "vehicle_health"){
        const data = await apiGetJSON(`/api/health_tabs/${encodeURIComponent(MODEL_NAME)}`);
        const tabs = Array.isArray(data.health_tabs) ? data.health_tabs : [];
        const rawKey = normKey(PARAMETER_RAW);

        for (const t of tabs){
            if (normKey(t.folder_code) === rawKey) return t.folder_code;
            if (normKey(t.folder_name) === rawKey) return t.folder_code;
        }

        const cands = candidateCodes(PARAMETER_RAW).map(normKey);
        for (const t of tabs){
            if (cands.includes(normKey(t.folder_code)) || cands.includes(normKey(t.folder_name))) return t.folder_code;
        }

        return PARAMETER_RAW;
    }

    return PARAMETER_RAW;
}

// ===================== Output limit helpers =====================
function toNumber(v){
    if (v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
}

function checkWithinLimits(outputDict, limits){
    if (!outputDict || typeof outputDict !== "object" || !Array.isArray(limits) || !limits.length) return true;
    for (const lim of limits){
        const sig = lim.signal;
        if (!sig || outputDict[sig] === undefined) continue;
        const val = toNumber(outputDict[sig]);
        if (val === null) continue;
        const lsl = toNumber(lim.lsl);
        const usl = toNumber(lim.usl);
        if (lsl !== null && val < lsl) return false;
        if (usl !== null && val > usl) return false;
    }
    return true;
}

function formatOutputCompact(payload, limits){
    if (payload === null || payload === undefined) return { text: "–", ok: true };
    if (typeof payload !== "object"){
        const vnum = toNumber(payload);
        if (!limits?.length || vnum === null) return { text: String(payload), ok: true };
        const lim = limits[0];
        const unit = lim?.unit ? ` ${lim.unit}` : "";
        const ok = checkWithinLimits({[lim.signal]: vnum}, limits);
        return { text: `${vnum}${unit}`, ok };
    }
    const parts = [];
    for (const lim of (limits || [])){
        const sig = lim.signal;
        if (!sig) continue;
        if (payload[sig] === undefined) continue;
        const v = payload[sig];
        const vnum = toNumber(v);
        const unit = lim.unit ? ` ${lim.unit}` : "";
        parts.push(`${sig}=${vnum !== null ? vnum : v}${unit}`);
    }
    if (!parts.length) return { text: JSON.stringify(payload), ok: true };
    const ok = checkWithinLimits(payload, limits);
    return { text: parts.join(" · "), ok };
}

function parseProgressJsonLine(line){
    const m = line.match(/\[PROGRESS_JSON\]\s+(.*)$/);
    if (!m) return null;
    try { return JSON.parse(m[1]); } catch { return null; }
}

// ===================== Task log polling =====================
function startTaskLogPolling(taskId, onNewLine, targetAreaId = "logArea"){
    if (perTaskLogTimers.has(taskId)) return;
    let lastLen = 0;

    const timer = setInterval(async () => {
        try{
            const text = await apiTaskLogs(taskId);
            if (text.length < lastLen) lastLen = 0;
            if (text.length === lastLen) return;

            const chunk = text.substring(lastLen);
            lastLen = text.length;

            const lines = chunk.split("\n").filter(l => l.trim().length);
            for (const line of lines){
                appendLogLine(line, targetAreaId);
                if (onNewLine) onNewLine(line);
            }
        }catch(e){
            console.warn("Log polling error:", e);
        }
    }, 500);

    perTaskLogTimers.set(taskId, timer);
}

function stopTaskLogPolling(taskId){
    const t = perTaskLogTimers.get(taskId);
    if (t){
        clearInterval(t);
        perTaskLogTimers.delete(taskId);
    }
}

// ===================== Controls =====================
function setControls({runningAny, paused}){
    const btnPause = document.getElementById("btnPause");
    const btnResume = document.getElementById("btnResume");
    const btnCancelAll = document.getElementById("btnCancelAll");

    const anyStreaming = TESTS.some(t => t.execution_mode === "stream" || t.execution_mode === "live");
    btnPause.disabled = !(runningAny && !paused && anyStreaming);
    btnResume.disabled = !paused || !anyStreaming;
    btnCancelAll.disabled = !runningAny;
}

// ===================== EXECUTION CORE =====================
async function runRowTest(test, rowEl, opts = {}){
    const statusEl = rowEl.querySelector(".status");
    const outputEl = rowEl.querySelector(".output");
    const actionBtn = rowEl.querySelector("button[data-action='run']");
    const cancelBtn = rowEl.querySelector("button[data-action='cancel']");

    rowEl.classList.remove("success", "failed", "streaming");
    rowEl.classList.add("running");
    statusEl.className = "status st-running";
    statusEl.innerHTML = (test.execution_mode === "stream" || test.execution_mode === "live") 
        ? '<i class="fas fa-sync fa-spin me-1"></i>Streaming' 
        : '<i class="fas fa-spinner fa-spin me-1"></i>Running';
    
    if (outputEl) outputEl.classList.remove("value-within", "value-violation");

    if (actionBtn){
        actionBtn.disabled = true;
        actionBtn.innerHTML = (test.execution_mode === "stream" || test.execution_mode === "live") 
            ? '<i class="fas fa-sync fa-spin me-1"></i>Streaming...' 
            : '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
    }

    if (cancelBtn && (test.execution_mode === "stream" || test.execution_mode === "live")){
        cancelBtn.style.display = "inline-block";
        cancelBtn.disabled = false;
    } else if (cancelBtn){
        cancelBtn.style.display = "none";
    }

    const user_inputs = opts.user_inputs || {};

    let taskId;
    try{
        taskId = await apiRunTest(test.id, user_inputs);
    }catch(e){
        rowEl.classList.remove("running");
        rowEl.classList.add("failed");
        statusEl.className = "status st-failed";
        statusEl.innerHTML = '<i class="fas fa-times-circle me-1"></i>Failed';
        if (outputEl) outputEl.textContent = e.message || "Execution failed";
        if (actionBtn){ 
            actionBtn.disabled = false; 
            actionBtn.innerHTML = test.button_name;
        }
        if (cancelBtn) cancelBtn.style.display = "none";
        return;
    }

    activeTaskIds.add(taskId);
    updateLogStats();
    setControls({runningAny:true, paused: globalPaused});

    startTaskLogPolling(taskId, (line) => {
        if (!outputEl) return;
        const payload = parseProgressJsonLine(line);
        if (!payload) return;

        const { text, ok } = formatOutputCompact(payload, test.output_limits);
        outputEl.textContent = text;

        outputEl.classList.remove("value-within", "value-violation");
        if (test.output_limits && test.output_limits.length){
            outputEl.classList.add(ok ? "value-within" : "value-violation");
        }
    });

    if (cancelBtn && (test.execution_mode === "stream" || test.execution_mode === "live")){
        cancelBtn.onclick = async () => {
            try{
                userCancelledTaskIds.add(taskId);
                await apiCancel(taskId);
            }catch(e){}

            rowEl.classList.remove("running");
            rowEl.classList.add("success");
            statusEl.className = "status st-success";
            statusEl.innerHTML = '<i class="fas fa-check-circle me-1"></i>Success';
            if (actionBtn){ 
                actionBtn.disabled = false; 
                actionBtn.innerHTML = test.button_name;
            }
            cancelBtn.style.display = "none";

            activeTaskIds.delete(taskId);
            stopTaskLogPolling(taskId);
            updateLogStats();
            setControls({runningAny: activeTaskIds.size > 0, paused: globalPaused});
        };
    }

    const monitor = setInterval(async () => {
        if (globalPaused) return;

        const st = await apiTaskStatus(taskId);
        if (["PENDING","RUNNING","PAUSED"].includes(st.status)) return;

        clearInterval(monitor);
        stopTaskLogPolling(taskId);
        activeTaskIds.delete(taskId);
        updateLogStats();
        setControls({runningAny: activeTaskIds.size > 0, paused: globalPaused});

        if (userCancelledTaskIds.has(taskId)){
            userCancelledTaskIds.delete(taskId);
            return;
        }

        const res = st.result || {};
        const passed = !!res.pass;
        const isStream = test.execution_mode === "stream" || test.execution_mode === "live";

        rowEl.classList.remove("running");
        if (isStream && st.status === "STREAMING") {
            rowEl.classList.add("streaming");
            statusEl.className = "status st-streaming";
            statusEl.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Streaming';
        } else {
            rowEl.classList.add(passed ? "success" : "failed");
            statusEl.className = passed ? "status st-success" : "status st-failed";
            statusEl.innerHTML = passed 
                ? '<i class="fas fa-check-circle me-1"></i>Success' 
                : '<i class="fas fa-times-circle me-1"></i>Failed';
        }

        if (outputEl){
            if (res.output !== undefined && res.output !== null){
                const { text, ok } = formatOutputCompact(res.output, test.output_limits);
                outputEl.textContent = text;

                outputEl.classList.remove("value-within", "value-violation");
                if (test.output_limits && test.output_limits.length){
                    outputEl.classList.add(ok ? "value-within" : "value-violation");
                }
            } else if (res.exception){
                outputEl.textContent = String(res.exception);
            }

            if (Array.isArray(res.limit_violations) && res.limit_violations.length){
                outputEl.classList.remove("value-within");
                outputEl.classList.add("value-violation");
            }
        }

        if (actionBtn){
            actionBtn.disabled = false;
            actionBtn.innerHTML = test.button_name;
        }
        if (cancelBtn) cancelBtn.style.display = "none";
    }, 800);
}

// ===================== Stream values polling (FIX-64) =====================
async function pollStreamValues() {
    if (!AUTO_RUN_SESSION_ID) return;
    
    try {
        const data = await apiGetStreamValues(AUTO_RUN_SESSION_ID);
        if (!data.ok) return;
        
        const container = document.getElementById('streamValuesContainer');
        const countEl = document.getElementById('streamCount');
        const timestampEl = document.getElementById('streamTimestamp');
        
        if (!data.values || !data.values.length) {
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-sync fa-spin me-2"></i>Waiting for stream data...</div>';
            if (countEl) countEl.textContent = '0 signals';
            return;
        }
        
        if (countEl) countEl.textContent = `${data.values.length} signals`;
        
        if (timestampEl) {
            const latest = data.values.reduce((max, v) => {
                const t = new Date(v.updated_at || 0).getTime();
                return t > max ? t : max;
            }, 0);
            if (latest > 0) {
                timestampEl.textContent = `Last update: ${new Date(latest).toLocaleTimeString()}`;
            }
        }
        
        // Group by program
        const byProgram = {};
        data.values.forEach(v => {
            if (!byProgram[v.program_id]) byProgram[v.program_id] = [];
            byProgram[v.program_id].push(v);
        });
        
        let html = '';
        for (const [programId, values] of Object.entries(byProgram)) {
            html += `<div class="mb-3"><strong>${programId}</strong>`;
            values.forEach(v => {
                const withinClass = v.is_within_limit ? 'within' : 'violation';
                html += `
                    <div class="stream-value-row">
                        <span class="label">${v.signal_name}:</span>
                        <span>
                            <span class="value ${withinClass}">${v.signal_value}</span>
                            ${v.signal_unit ? `<span class="unit">${v.signal_unit}</span>` : ''}
                            ${v.is_within_limit === false ? ' <i class="fas fa-exclamation-triangle text-danger ms-1"></i>' : ''}
                        </span>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        container.innerHTML = html;
        lastStreamUpdate = new Date();
        
    } catch (e) {
        console.error('Failed to poll stream values:', e);
    }
}

// ===================== Renderers =====================
function renderSequenceGrid(){
    const container = document.getElementById("containerSequence");
    container.innerHTML = "";

    for (const test of TESTS){
        const limitsText = (test.output_limits || []).map(l => {
            if (!l.signal) return "";
            const unit = l.unit ? ` ${l.unit}` : "";
            const hasL = (l.lsl !== null && l.lsl !== undefined);
            const hasU = (l.usl !== null && l.usl !== undefined);
            if (hasL && hasU) return `${l.signal}: ${l.lsl}–${l.usl}${unit}`;
            if (hasL) return `${l.signal}: ≥ ${l.lsl}${unit}`;
            if (hasU) return `${l.signal}: ≤ ${l.usl}${unit}`;
            return `${l.signal}`;
        }).filter(Boolean).join(" · ");

        const row = document.createElement("div");
        row.className = "seq-row";
        row.dataset.testId = test.id;

        row.innerHTML = `
            <div class="info">
                <h6>${test.label}</h6>
                <div class="desc">${test.description || "—"}</div>
                ${limitsText ? `<div class="small text-muted mt-2"><i class="fas fa-chart-line me-1"></i>Limits: <span class="font-monospace">${limitsText}</span></div>` : ``}
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-primary" data-action="run">${test.button_name}</button>
                <button class="btn btn-sm btn-outline-danger" data-action="cancel" style="display:none;">Cancel</button>
            </div>

            <div class="output">–</div>
            <div class="status st-idle">Idle</div>
        `;

        row.querySelector("button[data-action='run']").onclick = () => runRowTest(test, row, {user_inputs:{}});
        container.appendChild(row);
    }
}

// ===================== Load tests =====================
async function loadTests(){
    setLoadMessage("info", '<i class="fas fa-spinner fa-spin me-2"></i>Loading tests…');

    let loaded = (SERVER_TESTS_RAW || []).map(normalizeTest);

    if (!loaded.length){
        setLoadMessage("warning", '<i class="fas fa-exclamation-triangle me-2"></i>No tests received from server. Resolving parameter...');

        const resolved = await resolveParameterCode();
        const attempts = Array.from(new Set([resolved, PARAMETER_RAW, ...candidateCodes(PARAMETER_RAW)]));

        for (const p of attempts){
            const apiTests = await apiFetchTests(MODEL_NAME, SECTION, ECU, p);
            if (apiTests.length){
                loaded = apiTests.map(normalizeTest);
                break;
            }
        }
    }

    if (!loaded.length){
        setLoadMessage("danger", '<i class="fas fa-exclamation-circle me-2"></i>No tests defined for this parameter. Most likely parameter code mismatch.');
        return false;
    }

    TESTS = loaded;
    PAGE_TYPE = derivePageType(TESTS);
    hideLoadMessage();
    return true;
}

// ===================== INIT =====================
document.addEventListener("DOMContentLoaded", async () => {
    setupLogButtons();
    updateLogStats();

    const btnRunAll = document.getElementById("btnRunAll");
    if (btnRunAll) btnRunAll.onclick = runAll;
    document.getElementById("btnPause").onclick = pauseAll;
    document.getElementById("btnResume").onclick = resumeAll;
    document.getElementById("btnCancelAll").onclick = cancelAll;

    const ok = await loadTests();
    if (!ok) return;

    renderByPageType();
    bindScanButtons(document);
    
    // Start stream polling if auto-run session exists
    if (AUTO_RUN_SESSION_ID && PAGE_TYPE === 'LIVE_PARAMETER') {
        await pollStreamValues();
        streamPollInterval = setInterval(pollStreamValues, 1000);
    }
});

// Pause polling when tab hidden
document.addEventListener("visibilitychange", () => {
    if (document.hidden){
        for (const [taskId, timer] of perTaskLogTimers.entries()){
            clearInterval(timer);
            perTaskLogTimers.delete(taskId);
        }
        if (streamPollInterval) {
            clearInterval(streamPollInterval);
            streamPollInterval = null;
        }
    } else {
        for (const id of Array.from(activeTaskIds)) {
            startTaskLogPolling(id, null, "logArea");
        }
        if (AUTO_RUN_SESSION_ID && !streamPollInterval && PAGE_TYPE === 'LIVE_PARAMETER') {
            pollStreamValues();
            streamPollInterval = setInterval(pollStreamValues, 1000);
        }
    }
});

// Warn before leaving if tasks active
window.addEventListener("beforeunload", (ev) => {
    if (activeTaskIds.size > 0){
        ev.preventDefault();
        ev.returnValue = "Tests are running. Leave anyway?";
        return ev.returnValue;
    }
});

// Cleanup on page unload
window.addEventListener("unload", () => {
    if (streamPollInterval) {
        clearInterval(streamPollInterval);
        streamPollInterval = null;
    }
});

// ===================== Helper functions =====================
function normalizeTest(t){
    const exec = String(t.execution_mode || "single").toLowerCase();
    const supportsDefault = (exec === "stream" || exec === "live") ? false : true;
    return {
        id: String(t.id),
        label: t.label || t.id,
        description: t.description || "",
        button_name: t.button_name || "Run",
        parameter_page_type: t.parameter_page_type || null,
        execution_mode: exec,
        supports_run_all: (t.supports_run_all ?? supportsDefault) === true,
        timeout_sec: Number(t.timeout_sec || 15),
        inputs: Array.isArray(t.inputs) ? t.inputs : [],
        output_limits: Array.isArray(t.output_limits) ? t.output_limits : [],
        function_role: t.function_role || null
    };
}

function derivePageType(tests){
    const types = Array.from(new Set(tests.map(t => t.parameter_page_type || "LIVE_PARAMETER")));
    return types[0];
}

function renderByPageType(){
    const anyStreaming = TESTS.some(t => t.execution_mode === "stream" || t.execution_mode === "live");
    document.getElementById("btnPause").disabled = !anyStreaming;
    document.getElementById("btnResume").disabled = true;
    setControls({runningAny:false, paused:false});

    if (PAGE_TYPE === "LIVE_PARAMETER") {
        renderSequenceGrid();
    } else {
        // Other page types would be handled here
        renderSequenceGrid();
    }
}

function setupLogButtons(){
    document.getElementById("btnClearLog").onclick = () => {
        const area = document.getElementById("logArea");
        area.textContent = "";
        logLineCount = 0;
        updateLogStats();
    };

    document.getElementById("btnSaveLog").onclick = () => {
        const text = document.getElementById("logArea").textContent || "";
        const ts = new Date().toISOString().replace(/[:.]/g,"-");
        const blob = new Blob([text], {type:"text/plain"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `nirix_log_${MODEL_NAME}_${PARAMETER_RAW}_${ts}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 800);
    };
}

async function runAll(){
    const runnable = TESTS.filter(t => t.supports_run_all !== false);
    for (const t of runnable){
        const row = document.querySelector(`.seq-row[data-test-id="${t.id}"]`);
        if (!row) continue;
        await runRowTest(t, row, {user_inputs:{}});
        await new Promise(r => setTimeout(r, 250));
    }
}

function pauseAll(){
    globalPaused = true;
    for (const id of Array.from(activeTaskIds)){
        apiPause(id).catch(()=>{});
    }
    setControls({runningAny: activeTaskIds.size>0, paused:true});
}

function resumeAll(){
    globalPaused = false;
    for (const id of Array.from(activeTaskIds)){
        apiResume(id).catch(()=>{});
    }
    setControls({runningAny: activeTaskIds.size>0, paused:false});
}

function cancelAll(){
    for (const id of Array.from(activeTaskIds)){
        userCancelledTaskIds.add(id);
        apiCancel(id).catch(()=>{});
        stopTaskLogPolling(id);
        activeTaskIds.delete(id);
    }
    updateLogStats();
    setControls({runningAny:false, paused:false});
}

function bindScanButtons(root=document){
    root.querySelectorAll(".js-scan-btn").forEach(btn => {
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";
        btn.addEventListener("click", async () => {
            const target = btn.dataset.target;
            const kind = btn.dataset.scanKind || "text";
            await scanAndFillInput(target, kind);
        });
    });
}
</script>
{% endif %}
{% endblock %}
