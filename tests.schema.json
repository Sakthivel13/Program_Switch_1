{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nirix.tvsmotor.com/schema/tests.schema.json",
  "title": "NIRIX Diagnostic Tests Definition",
  "description": "Individual test sequence definitions",
  "version": "2.1.0",
  "type": "object",

  "required": ["vehicle", "section", "parameter", "tests"],

  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "2.1.0",
      "description": "Schema version for compatibility checking"
    },

    "vehicle": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "Must match app.vehicles.name"
    },

    "section": {
      "type": "string",
      "enum": ["diagnostics", "vehicle_health"],
      "description": "Maps to app.tests.section"
    },

    "ecu": {
      "type": ["string", "null"],
      "pattern": "^[A-Za-z0-9_-]+$",
      "minLength": 1,
      "maxLength": 50,
      "description": "ECU code - maps to app.tests.ecu - Required when section=diagnostics"
    },

    "parameter": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "Parameter code - maps to app.tests.parameter"
    },

    "tests": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/test" }
    }
  },

  "allOf": [
    {
      "if": {
        "properties": { "section": { "const": "diagnostics" } }
      },
      "then": {
        "required": ["ecu"],
        "properties": {
          "ecu": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    }
  ],

  "additionalProperties": false,

  "$defs": {
    "test": {
      "type": "object",

      "required": [
        "id",
        "label",
        "module_name",
        "function_name",
        "parameter_page_type"
      ],

      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_\\-]+$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Unique test ID - maps to app.tests.id"
        },

        "label": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Test sequence name - maps to app.tests.label"
        },

        "description": {
          "type": ["string", "null"],
          "maxLength": 1000,
          "description": "Test description"
        },

        "module_name": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_\\.]+$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Python module name (without .py)"
        },

        "function_name": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Python function name"
        },

        "parameter_page_type": {
          "type": "string",
          "enum": [
            "LIVE_PARAMETER",
            "WRITE_DATA_IDENTIFIER",
            "INPUT_OUTPUT_CONTROL",
            "ROUTINE_CONTROL",
            "DTC",
            "ECU_FLASHING",
            "IUPR",
            "VEHICLE_HEALTH",
            "VEHICLE_HEALTH_IO",
            "VEHICLE_HEALTH_PHYSICAL",
            "DEALER_DETAILS"
          ],
          "description": "Maps to app.tests.parameter_page_type"
        },

        "button_name": {
          "type": "string",
          "maxLength": 50,
          "default": "Run",
          "description": "Button label in UI"
        },

        "function_role": {
          "oneOf": [
            {
              "type": "string",
              "enum": ["READ", "CLEAR", "WRITE", "CONTROL"]
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "For DTC tests only - maps to app.tests.function_role"
        },

        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+$",
          "default": "1.0",
          "description": "Test version"
        },

        "is_active": {
          "type": "boolean",
          "default": true
        },

        "sort_order": {
          "type": "integer",
          "minimum": 0,
          "maximum": 9999,
          "default": 0
        },

        "inputs": {
          "type": "array",
          "items": { "$ref": "#/$defs/input" },
          "default": []
        },

        "output_limits": {
          "type": "array",
          "items": { "$ref": "#/$defs/output_limit" },
          "default": [],
          "description": "LSL/USL limits for streaming tests"
        },

        "execution": {
          "$ref": "#/$defs/execution_config",
          "description": "Execution configuration"
        },

        "flashing": {
          "oneOf": [
            { "$ref": "#/$defs/flashing_config" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Flashing configuration - required when parameter_page_type is ECU_FLASHING"
        },

        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 50
          },
          "default": [],
          "description": "Optional tags for categorizing tests"
        },

        "dependencies": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-zA-Z0-9_\\-]+$"
          },
          "default": [],
          "description": "Test IDs that must run before this test"
        }
      },

      "allOf": [
        {
          "if": {
            "properties": {
              "parameter_page_type": { "const": "ECU_FLASHING" }
            }
          },
          "then": {
            "properties": {
              "flashing": {
                "$ref": "#/$defs/flashing_config"
              }
            },
            "required": ["flashing"]
          }
        },
        {
          "if": {
            "properties": {
              "parameter_page_type": { "const": "DTC" }
            }
          },
          "then": {
            "properties": {
              "function_role": {
                "type": "string",
                "enum": ["READ", "CLEAR"]
              }
            },
            "required": ["function_role"]
          }
        },
        {
          "if": {
            "properties": {
              "execution": {
                "properties": {
                  "mode": { "const": "stream" }
                }
              }
            }
          },
          "then": {
            "properties": {
              "output_limits": {
                "type": "array",
                "minItems": 1
              }
            }
          }
        }
      ],

      "additionalProperties": false
    },

    "input": {
      "type": "object",
      "required": ["name", "input_type"],

      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Maps to app.test_inputs.name"
        },

        "label": {
          "type": ["string", "null"],
          "maxLength": 200,
          "description": "Maps to app.test_inputs.label"
        },

        "input_type": {
          "type": "string",
          "enum": ["int", "float", "string", "hex", "bool", "enum", "datetime", "file"],
          "description": "Maps to app.test_inputs.input_type"
        },

        "length": {
          "type": ["integer", "null"],
          "minimum": 1,
          "maximum": 1000,
          "description": "Expected input length"
        },

        "min_value": {
          "type": ["number", "null"],
          "description": "Minimum allowed value"
        },

        "max_value": {
          "type": ["number", "null"],
          "description": "Maximum allowed value"
        },

        "enum_values": {
          "oneOf": [
            {
              "type": "array",
              "items": {
                "type": ["string", "number", "boolean"]
              },
              "minItems": 1
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Maps to app.test_inputs.enum_values (JSONB). Use array for enum type, null for others."
        },

        "default_value": {
          "type": ["string", "number", "boolean", "null"],
          "default": null,
          "description": "Maps to app.test_inputs.default_value"
        },

        "format_hint": {
          "type": ["string", "null"],
          "maxLength": 200,
          "description": "Format hint (e.g., DDMMYYYY, 12 hex chars) - maps to app.test_inputs.format_hint"
        },

        "is_required": {
          "type": "boolean",
          "default": false,
          "description": "Maps to app.test_inputs.is_required"
        },

        "config_key": {
          "type": ["string", "null"],
          "maxLength": 100,
          "description": "DB key for storing default values - maps to app.test_inputs.config_key"
        },

        "sort_order": {
          "type": "integer",
          "minimum": 0,
          "maximum": 9999,
          "default": 0
        },

        "validation_pattern": {
          "type": ["string", "null"],
          "description": "Regex pattern for input validation"
        }
      },

      "additionalProperties": false
    },

    "output_limit": {
      "type": "object",
      "required": ["signal"],

      "properties": {
        "signal": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_]+$",
          "minLength": 1,
          "maxLength": 100,
          "description": "Output key name - maps to app.test_output_limits.signal"
        },

        "lsl": {
          "type": ["number", "null"],
          "description": "Lower Specification Limit"
        },

        "usl": {
          "type": ["number", "null"],
          "description": "Upper Specification Limit"
        },

        "unit": {
          "type": ["string", "null"],
          "maxLength": 20,
          "description": "Engineering unit (rpm, V, Â°C, %)"
        }
      },

      "additionalProperties": false
    },

    "execution_config": {
      "type": "object",

      "properties": {
        "mode": {
          "type": "string",
          "enum": ["single", "live", "stream", "flash", "flashing"],
          "default": "single",
          "description": "Maps to app.test_execution_config.execution_mode"
        },

        "supports_run_all": {
          "type": "boolean",
          "default": true,
          "description": "Maps to app.test_execution_config.supports_run_all"
        },

        "timeout_sec": {
          "type": "number",
          "minimum": 1,
          "maximum": 3600,
          "default": 15
        },

        "max_retries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "default": 3
        },

        "retry_delay_sec": {
          "type": "number",
          "minimum": 0,
          "maximum": 10,
          "default": 1.5
        },

        "retry_on_timeout": {
          "type": "boolean",
          "default": false
        },

        "retry_on_exception": {
          "type": "boolean",
          "default": false
        },

        "requires_confirmation": {
          "type": "boolean",
          "default": false,
          "description": "Whether the test requires user confirmation before running"
        },

        "requires_hardware": {
          "type": "boolean",
          "default": true,
          "description": "Whether the test requires hardware (CAN bus)"
        }
      },

      "additionalProperties": false
    },

    "flashing_config": {
      "type": "object",
      "required": ["file_name", "file_type", "method"],

      "properties": {
        "file_name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "Maps to app.test_flashing_config.file_name"
        },

        "file_type": {
          "type": "string",
          "enum": ["HEX", "BIN", "SREC", "S19", "SRE", "ELF"],
          "description": "Firmware file type"
        },

        "method": {
          "type": "string",
          "enum": ["UDS", "BOOTLOADER", "OEM", "CAN", "KWP", "ISO15765"],
          "description": "Flashing method"
        },

        "required_inputs": {
          "oneOf": [
            {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
              }
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Array of required input names - maps to app.test_flashing_config.required_inputs"
        },

        "verify_after_flash": {
          "type": "boolean",
          "default": true,
          "description": "Whether to verify the flash after programming"
        },

        "allow_downgrade": {
          "type": "boolean",
          "default": false,
          "description": "Whether to allow flashing older firmware versions"
        },

        "min_battery_voltage": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 100,
          "description": "Minimum battery voltage required for flashing"
        }
      },

      "additionalProperties": false
    }
  }
}
